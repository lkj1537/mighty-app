<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mighty Master</title>
    <script src="config.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; overflow-y: hidden; }
        .menu-card { transition: all 0.2s; border: 1px solid #e5e7eb; }
        .menu-card:active { transform: scale(0.95); background-color: #f9fafb; }
        [v-cloak] { display: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .chip-change { animation: pop 0.3s ease-out forwards; }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        /* ì»¤ìŠ¤í…€ ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; background: #e5e7eb; border-radius: 4px; }
        input[type=range]::-webkit-slider-thumb { height: 24px; width: 24px; border-radius: 50%; background: #2563eb; cursor: pointer; -webkit-appearance: none; margin-top: -8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-md mx-auto h-[100dvh] bg-white shadow-xl flex flex-col overflow-hidden relative">
        
        <header class="bg-gray-900 text-white py-3 px-4 text-center shadow-md z-10 shrink-0 flex justify-between items-center">
            <h1 class="text-sm font-black italic tracking-tighter">MIGHTY MASTER</h1>
            <button v-if="step > 2" @click="endGame" class="text-[10px] text-gray-400 font-bold border border-gray-600 px-2 py-1 rounded active:bg-gray-700">ê¸°ë¡ ì´ˆê¸°í™”</button>
        </header>

        <main class="flex-grow p-3 flex flex-col overflow-y-auto">
            
            <section v-if="step === 1" class="flex-grow flex flex-col justify-center space-y-4">
                <div class="text-center mb-6">
                    <p class="text-gray-400 text-xs font-bold uppercase tracking-widest">Welcome</p>
                    <h2 class="text-2xl font-black text-gray-800">ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</h2>
                </div>
                <button v-if="hasSavedSession" @click="loadSession" class="menu-card w-full p-5 rounded-2xl bg-blue-50 border-blue-200 shadow-sm flex items-center justify-between">
                    <div class="text-left"><h3 class="text-lg font-black text-blue-800">ì´ì „ ê²Œì„ ì´ì–´ì„œ í•˜ê¸°</h3><p class="text-xs text-blue-500">ì €ì¥ëœ ë°ì´í„° ë³µêµ¬</p></div>
                    <span class="text-2xl">ğŸ”„</span>
                </button>
                <button @click="step = 2" class="menu-card w-full p-6 rounded-2xl bg-white shadow-sm flex items-center justify-between group">
                    <div class="text-left"><h3 class="text-lg font-black text-gray-800">ìƒˆ ê²Œì„ ì‹œì‘</h3><p class="text-xs text-gray-400">ì¸ì› ì„ íƒ ë° ë¹„ë”©</p></div>
                    <span class="text-3xl">ğŸƒ</span>
                </button>
            </section>

            <section v-if="step === 2" class="flex flex-col h-full space-y-4">
                <div class="flex justify-between items-center pb-1 border-b">
                    <h2 class="text-xl font-black text-gray-800">ì¸ì› ì„ íƒ (5~6ëª…)</h2>
                    <span :class="['font-black text-sm', selectedPlayers.length >= 5 && selectedPlayers.length <= 6 ? 'text-blue-600' : 'text-red-500']">{{ selectedPlayers.length }} ëª…</span>
                </div>
                <div class="grid grid-cols-2 gap-2 max-h-[45vh] overflow-y-auto p-1">
                    <button v-for="name in playerList" :key="name" @click="togglePlayer(name)"
                        :class="['p-3 rounded-xl border-2 text-sm font-bold transition-all flex items-center justify-center gap-2', selectedPlayers.includes(name) ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-gray-100 bg-white text-gray-400']">
                        <span v-if="selectedPlayers.includes(name)" class="text-xs bg-blue-600 text-white rounded-md px-1.5 py-0.5 font-black">{{ selectedPlayers.indexOf(name) + 1 }}</span>
                        {{ name }}
                    </button>
                </div>
                <div class="bg-gray-100 p-2 rounded-xl flex gap-2 shrink-0">
                    <input v-model="newPlayerName" @keyup.enter="addPlayer" class="flex-grow bg-transparent px-3 text-sm outline-none" placeholder="ì‹ ê·œ ë©¤ë²„ ì¶”ê°€...">
                    <button @click="addPlayer" :disabled="isAddingPlayer" class="bg-white px-3 py-2 rounded-lg text-xs font-black shadow-sm disabled:opacity-50">ë“±ë¡</button>
                </div>
                <div class="mt-auto pt-2 shrink-0">
                    <button @click="startGame" :disabled="selectedPlayers.length < 5 || selectedPlayers.length > 6 || loading"
                        class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black text-base shadow-lg disabled:bg-gray-200">
                        {{ loading ? 'ì‹œì‘ ì¤‘...' : (selectedPlayers.length === 6 ? '6ë§ˆ ì‹œì‘' : '5ë§ˆ ì‹œì‘') }}
                    </button>
                </div>
            </section>

            <section v-if="step === 3" class="flex flex-col h-full space-y-2 relative">
                <div class="flex justify-between items-center px-1 shrink-0">
                    <h2 class="text-sm font-black text-gray-800">Round {{ roundCount }} ë¹„ë”©</h2>
                </div>

                <div class="space-y-1.5 shrink-0 bg-blue-50 p-2.5 rounded-xl border border-blue-100">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[11px] font-black text-blue-600 uppercase tracking-widest ml-1">ì£¼ê³µ ì„ íƒ</label>
                        <button v-if="players.length === 6" @click="showStandbyModal = true" class="text-[10px] bg-white border border-gray-300 px-2 py-1 rounded font-bold">íœ´ì‹ ì§€ì • âš™ï¸</button>
                    </div>
                    <div class="grid grid-cols-3 gap-1.5">
                        <button v-for="p in players" :key="p.name" @click="selectDealer(p.name)"
                            :disabled="standbyPlayer === p.name"
                            :class="['p-2 rounded-lg border-2 flex flex-col items-center justify-center transition-all relative',
                                standbyPlayer === p.name ? 'border-gray-200 bg-gray-100 opacity-60' :
                                formData.dealer === p.name ? 'border-blue-600 bg-white text-blue-700 shadow-md ring-1 ring-blue-100' : 'border-gray-200 bg-white text-gray-700 shadow-sm']">
                            <span v-if="standbyPlayer === p.name" class="absolute top-1 left-1 bg-red-500 text-white text-[8px] font-black px-1 rounded shadow-sm">íœ´ì‹</span>
                            <span class="text-xs font-black">{{ p.name }}</span>
                            <span :class="['text-[10px] font-bold mt-0.5 opacity-60']">{{ p.chips }}</span>
                        </button>
                    </div>
                </div>

                <div class="flex-grow flex flex-col overflow-hidden min-h-[180px] bg-gray-50 rounded-xl border">
                    <div class="py-2 pr-2 pl-0 overflow-x-auto hide-scrollbar flex-grow relative">
                        <div class="min-w-max flex flex-col gap-1.5">
                            <div v-for="s in suits" :key="s.name" class="flex items-center">
                                <div :class="['sticky left-0 bg-gray-50 w-10 h-8 flex items-center justify-center font-black text-[20px] shrink-0 z-30', s.textColor]">{{ s.symbol }}</div>
                                <div class="flex gap-2 ml-1 pr-8 relative z-0">
                                    <button v-for="num in bids" :key="num" @click="formData.suit = s.name; formData.bid = num"
                                        :class="['w-8 h-8 rounded-full border-2 font-black text-xs transition-all flex shrink-0 items-center justify-center', formData.suit === s.name && formData.bid === num ? 'bg-gray-800 text-white border-gray-800 scale-110 shadow-md' : 'bg-white border-gray-300 ' + s.textColor]">{{ num }}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="shrink-0 pt-1 pb-1">
                    <button @click="step = 4" :disabled="!isBiddingComplete" 
                        :class="['w-full py-4 rounded-2xl font-black text-sm shadow-lg transition-all', isBiddingComplete ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-400']">
                        {{ roundStartButtonText }}
                    </button>
                </div>
                
                <div v-if="showStandbyModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-5">
                    <div class="bg-white rounded-[2rem] w-full max-w-sm p-6 shadow-2xl">
                        <h3 class="text-lg font-black text-gray-800 text-center mb-4">ì´ë²ˆ íŒ íœ´ì‹ ì¸ì›</h3>
                        <div class="grid grid-cols-2 gap-3 mb-5">
                            <button v-for="p in players" :key="p.name" @click="setStandby(p.name)"
                                :class="['p-3 border-2 rounded-xl font-black text-sm', standbyPlayer === p.name ? 'border-blue-600 bg-blue-50 text-blue-600' : 'border-gray-200 bg-white']">{{ p.name }}</button>
                            <button @click="setStandby(null)" class="col-span-2 p-3 border-2 rounded-xl font-black text-sm bg-gray-50 text-gray-400">ì „ì› ì°¸ì—¬</button>
                        </div>
                        <button @click="showStandbyModal = false" class="w-full py-3.5 bg-gray-900 text-white font-black rounded-xl text-sm">ë‹«ê¸°</button>
                    </div>
                </div>
            </section>

            <section v-if="step === 4" class="flex flex-col h-full space-y-3">
                
                <div class="grid grid-cols-2 gap-2 shrink-0">
                    <div class="bg-white border border-gray-200 rounded-2xl p-3 flex items-center justify-center gap-3 shadow-sm">
                        <span :class="['text-2xl font-black', calculateMighty.color]">{{ calculateMighty.text }}</span>
                        <span class="text-[10px] font-black text-gray-400">ë§ˆì´í‹°</span>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-2xl p-3 flex items-center justify-center gap-3 shadow-sm">
                        <span class="text-2xl font-black text-gray-800">{{ calculateJokerCall.text }}</span>
                        <span class="text-[10px] font-black text-gray-400">ì¡°ì»¤ì½œ</span>
                    </div>
                </div>

                <div class="bg-blue-50 p-3 rounded-2xl border border-blue-100 shrink-0">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[11px] font-black text-blue-600 uppercase ml-1">í”„ë Œë“œ ì„ íƒ</label>
                        <button @click="formData.friend = 'ë…¸í”„ë Œë“œ'"
                            :class="['text-[10px] px-3 py-1 rounded-lg font-black border transition-all', 
                            formData.friend === 'ë…¸í”„ë Œë“œ' ? 'bg-red-500 text-white border-red-600 shadow-inner' : 'bg-white text-gray-600 border-gray-300']">
                            ë…¸í”„ë Œë“œ ğŸš«
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-1.5">
                        <button v-for="p in players" :key="p.name" @click="formData.friend = p.name"
                            :disabled="p.name === formData.dealer || standbyPlayer === p.name"
                            :class="[
                                'p-2 rounded-lg border-2 flex flex-col items-center justify-center transition-all relative min-h-[55px]',
                                standbyPlayer === p.name ? 'border-gray-200 bg-gray-100 opacity-60' :
                                formData.dealer === p.name ? 'border-amber-400 bg-amber-50 shadow-sm' :
                                formData.friend === p.name ? 'border-blue-600 bg-white text-blue-700 shadow-md ring-1' : 'border-gray-100 bg-white'
                            ]">
                            <span v-if="formData.dealer === p.name" class="absolute -top-3 text-lg drop-shadow-sm">ğŸ‘‘</span>
                            <span v-if="standbyPlayer === p.name" class="absolute top-1 left-1 bg-red-500 text-white text-[8px] font-black px-1 rounded">íœ´ì‹</span>
                            
                            <span class="text-xs font-black">{{ p.name }}</span>
                            <span class="text-[9px] font-bold opacity-50 mt-0.5">{{ p.chips }}</span>
                        </button>
                    </div>
                </div>

                <div class="flex-grow flex flex-col justify-center space-y-4">
                    <div class="flex items-center justify-between px-5 py-2.5 bg-gray-900 rounded-xl text-white shadow-inner">
                        <div class="flex items-center gap-2">
                            <span :class="['text-2xl font-black', currentSuit.textColor]">{{ currentSuit.symbol }}</span>
                            <span class="text-xl font-black tracking-tight">{{ formData.bid }}</span>
                        </div>
                        <div class="h-4 w-[1px] bg-gray-700"></div>
                        <div class="text-right">
                            <span class="text-[9px] font-bold text-gray-400 mr-2 uppercase">ì•¼ë‹¹ ëª©í‘œ</span>
                            <span class="text-lg font-black text-red-400">{{ 21 - formData.bid }}ì¥</span>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-3xl border-2 border-gray-100 shadow-sm flex flex-col items-center">
                        <div class="flex justify-between w-full items-center mb-5">
                            <label class="text-[11px] font-black text-gray-400 uppercase tracking-widest">í˜„ì¬ ì•¼ë‹¹ ì¥ìˆ˜</label>
                            <span :class="['px-3 py-1 rounded-full text-[10px] font-black text-white', isCurrentBidSuccess ? 'bg-green-500' : 'bg-red-500']">
                                {{ isCurrentBidSuccess ? 'ì—¬ë‹¹ ìŠ¹ë¦¬' : 'ì•¼ë‹¹ ìŠ¹ë¦¬' }}
                            </span>
                        </div>
                        
                        <div class="flex items-center justify-center gap-10 w-full mb-5">
                            <button @click="formData.oppScore = Math.max(0, formData.oppScore - 1)" class="w-12 h-12 rounded-full bg-gray-50 border border-gray-200 text-2xl font-black active:bg-gray-200 transition-colors">-</button>
                            <span class="text-7xl font-black w-24 text-center text-gray-800 tracking-tighter">{{ formData.oppScore }}</span>
                            <button @click="formData.oppScore = Math.min(20, formData.oppScore + 1)" class="w-12 h-12 rounded-full bg-gray-50 border border-gray-200 text-2xl font-black active:bg-gray-200 transition-colors">+</button>
                        </div>
                        
                        <input type="range" v-model.number="formData.oppScore" min="0" max="20" class="w-full mb-2">
                    </div>
                </div>

                <div class="flex gap-2 shrink-0 pt-2 pb-1">
                    <button @click="step = 3" class="flex-1 py-4 bg-gray-100 text-gray-500 rounded-2xl font-bold text-sm border">ë¹„ë”© ìˆ˜ì •</button>
                    <button @click="calculateResult" :disabled="!formData.friend || loading" 
                        class="flex-[2] py-4 bg-gray-900 text-white rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all disabled:bg-gray-200">
                        <span v-if="loading">ì²˜ë¦¬ ì¤‘...</span><span v-else>ê²°ê³¼ ì •ì‚°</span>
                    </button>
                </div>
            </section>

            <section v-if="step === 5" class="flex flex-col h-full space-y-3">
                <div :class="['py-5 rounded-3xl text-center border-4 shrink-0 shadow-lg relative', lastResult.isWin ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200']">
                    <button @click="revertResult" class="absolute top-3 left-3 text-[10px] font-bold text-gray-400 bg-white/80 px-2 py-1 rounded border active:bg-gray-100">â¬…ï¸ ê²°ê³¼ ì·¨ì†Œ</button>
                    <h2 :class="['text-3xl font-black mb-1 mt-4', lastResult.isWin ? 'text-green-600' : 'text-red-600']">{{ lastResult.isWin ? 'ì—¬ë‹¹ ìŠ¹ë¦¬ ğŸ‰' : 'ì•¼ë‹¹ ìŠ¹ë¦¬ ğŸ’€' }}</h2>
                    <p class="text-[12px] font-bold text-gray-500">{{ formData.suit }} {{ formData.bid }} ë¹„ë”© <span class="mx-1">|</span> ì•¼ë‹¹ {{ formData.oppScore }}ì¥</p>
                    <div class="mt-3 inline-flex items-center bg-white px-4 py-2 rounded-full shadow-sm border border-gray-100">
                        <span class="text-[10px] font-black text-gray-400 mr-3 uppercase">ê³„ì‚°: {{ lastResult.base }} Ã— {{ lastResult.multiplier }}</span>
                        <span class="text-lg font-black text-blue-600">{{ lastResult.finalUnit }} ìœ ë‹›</span>
                    </div>
                </div>

                <div class="flex-grow bg-white rounded-2xl shadow-inner border p-2 space-y-1.5 overflow-y-auto">
                    <div v-for="change in lastResult.changes" :key="change.name" class="flex justify-between items-center px-4 py-3 rounded-2xl bg-gray-50 chip-change border">
                        <div class="flex items-center gap-4">
                            <span :class="['font-black text-xl min-w-[3.5rem]', change.diff > 0 ? 'text-green-500' : 'text-red-500']">{{ change.diff > 0 ? '+' : '' }}{{ change.diff }}</span>
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="font-black text-gray-800">{{ change.name }}</span>
                                    <span v-if="change.role" class="text-[9px] font-bold text-white px-1.5 py-0.5 rounded shadow-sm" :class="change.role.includes('ì£¼ê³µ') ? 'bg-blue-600' : (change.role === 'í”„ë Œë“œ' ? 'bg-blue-400' : 'bg-gray-400')">{{ change.role }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] text-gray-400 font-bold mb-0.5 uppercase">ë³´ìœ  ì¹©</p>
                            <p class="font-black text-2xl text-gray-800 tracking-tighter">{{ change.newTotal }}</p>
                        </div>
                    </div>
                </div>

                <div class="mt-auto shrink-0 pt-1 pb-1">
                    <button @click="nextRound" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all">ë‹¤ìŒ ë¼ìš´ë“œ ì‹œì‘</button>
                </div>
            </section>

        </main>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    step: 1, playerList: [], selectedPlayers: [], players: [],
                    standbyPlayer: null, showStandbyModal: false, newPlayerName: '',
                    loading: false, isAddingPlayer: false, gameId: '', roundCount: 1,
                    suits: [
                        { symbol: 'N', name: 'ë…¸ê¸°ë£¨', textColor: 'text-gray-400' },
                        { symbol: 'â™ ', name: 'ìŠ¤í˜ì´ë“œ', textColor: 'text-gray-900' },
                        { symbol: 'â™¦', name: 'ë‹¤ì´ì•„', textColor: 'text-red-600' },
                        { symbol: 'â™£', name: 'í´ë¡œë²„', textColor: 'text-gray-900' },
                        { symbol: 'â™¥', name: 'í•˜íŠ¸', textColor: 'text-red-600' }
                    ],
                    bids: [13, 14, 15, 16, 17, 18, 19, 20],
                    formData: { dealer: '', friend: '', suit: null, bid: null, oppScore: 0 },
                    lastResult: {}
                }
            },
            computed: {
                hasSavedSession() { return localStorage.getItem('mightySession') !== null; },
                activePlayers() { return this.players.filter(p => p.name !== this.standbyPlayer); },
                
                // [ê°œì„ ] ìŠ¤ë§ˆíŠ¸ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë¡œì§
                roundStartButtonText() {
                    let missing = [];
                    if (this.players.length === 6 && !this.standbyPlayer) missing.push('íœ´ì‹');
                    if (!this.formData.dealer) missing.push('ì£¼ê³µ');
                    if (!this.formData.suit || !this.formData.bid) missing.push('ë¹„ë”©');

                    if (missing.length === 0) return "ë¼ìš´ë“œ ì‹œì‘";
                    return `ë¼ìš´ë“œ ì‹œì‘ (${missing.join(', ')})`;
                },

                isBiddingComplete() {
                    return this.formData.dealer && this.formData.suit && this.formData.bid && (this.players.length !== 6 || this.standbyPlayer);
                },
                currentSuit() {
                    return this.suits.find(s => s.name === this.formData.suit) || { symbol: '?', textColor: 'text-gray-300' };
                },
                isCurrentBidSuccess() {
                    return (20 - this.formData.oppScore) >= (this.formData.bid || 0);
                },
                calculateMighty() { 
                    if (!this.formData.suit) return { text: '-', color: 'text-gray-300' };
                    return this.formData.suit === 'ìŠ¤í˜ì´ë“œ' ? { text: 'â™¦ A', color: 'text-red-600' } : { text: 'â™  A', color: 'text-gray-900' };
                },
                calculateJokerCall() {
                    if (!this.formData.suit) return { text: '-', color: 'text-gray-300' };
                    return this.formData.suit === 'í´ë¡œë²„' ? { text: 'â™  3', color: 'text-gray-900' } : { text: 'â™£ 3', color: 'text-gray-900' }; 
                }
            },
            methods: {
                togglePlayer(name) {
                    const idx = this.selectedPlayers.indexOf(name);
                    if (idx > -1) this.selectedPlayers.splice(idx, 1);
                    else if (this.selectedPlayers.length < 6) this.selectedPlayers.push(name);
                },
                async fetchPlayers() {
                    try {
                        const res = await fetch(CONFIG.GAS_URL);
                        const data = await res.json();
                        this.playerList = data.players || [];
                    } catch (e) { console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨", e); }
                },
                async addPlayer() {
                    if(!this.newPlayerName) return;
                    this.isAddingPlayer = true;
                    this.playerList.push(this.newPlayerName);
                    this.togglePlayer(this.newPlayerName);
                    fetch(CONFIG.GAS_URL, {
                        method: "POST", mode: "no-cors",
                        headers: { "Content-Type": "text/plain" },
                        body: JSON.stringify({ action: "addPlayer", name: this.newPlayerName })
                    });
                    this.newPlayerName = '';
                    this.isAddingPlayer = false;
                },
                selectDealer(name) { this.formData.dealer = name; },
                setStandby(name) {
                    this.standbyPlayer = name;
                    if(this.formData.dealer === name) this.formData.dealer = '';
                    this.showStandbyModal = false;
                    this.saveSession();
                },
                async startGame() {
                    this.loading = true;
                    const today = new Date().toISOString().slice(2,10).replace(/-/g, '');
                    this.gameId = `M_${today}_${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
                    this.roundCount = 1;
                    this.players = this.selectedPlayers.map(name => ({ name, chips: 40 }));
                    fetch(CONFIG.GAS_URL, {
                        method: "POST", mode: "no-cors",
                        body: JSON.stringify({ action: "startGame", gameId: this.gameId, players: this.players })
                    });
                    this.saveSession();
                    this.step = 3;
                    this.loading = false;
                },
                saveSession() {
                    localStorage.setItem('mightySession', JSON.stringify({
                        gameId: this.gameId, roundCount: this.roundCount,
                        players: this.players, standbyPlayer: this.standbyPlayer
                    }));
                },
                loadSession() {
                    const data = JSON.parse(localStorage.getItem('mightySession'));
                    this.gameId = data.gameId; this.roundCount = data.roundCount;
                    this.players = data.players; this.standbyPlayer = data.standbyPlayer;
                    this.selectedPlayers = this.players.map(p => p.name);
                    this.step = 3;
                },
                endGame() {
                    if(confirm("ê¸°ë¡ì„ ì™„ì „íˆ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        localStorage.removeItem('mightySession');
                        this.step = 1; this.selectedPlayers = [];
                    }
                },
                async calculateResult() {
                    this.loading = true;
                    const { dealer, friend, suit, bid, oppScore } = this.formData;
                    const wonCards = 20 - oppScore;
                    const isWin = wonCards >= bid;
                    const isRun = (oppScore === 0);
                    const isBackrun = (oppScore >= 10);
                    let base = 0;
                    if (bid === 20) {
                        if (isWin) base = 20;
                        else if (isBackrun) base = 20; 
                        else base = Math.ceil((bid - wonCards) * 1.5); 
                    } else {
                        if (isWin) base = isRun ? 15 : wonCards - 10;
                        else base = isBackrun ? 15 : bid - wonCards;
                    }
                    let multiplier = (suit === 'ë…¸ê¸°ë£¨' ? 2 : 1) * (friend === 'ë…¸í”„ë Œë“œ' ? 2 : 1);
                    const finalUnit = base * multiplier;
                    let changes = [];
                    const opponents = this.activePlayers.filter(p => p.name !== dealer && p.name !== friend);
                    opponents.forEach(p => changes.push({ name: p.name, role: 'ì•¼ë‹¹', diff: isWin ? -finalUnit : finalUnit }));
                    if (friend === 'ë…¸í”„ë Œë“œ') changes.push({ name: dealer, role: 'ì£¼ê³µ(ë…¸í”„)', diff: isWin ? (finalUnit * 4) : -(finalUnit * 4) });
                    else {
                        changes.push({ name: friend, role: 'í”„ë Œë“œ', diff: isWin ? finalUnit : -finalUnit });
                        changes.push({ name: dealer, role: 'ì£¼ê³µ', diff: isWin ? (finalUnit * 2) : -(finalUnit * 2) });
                    }
                    changes.forEach(c => {
                        const player = this.players.find(p => p.name === c.name);
                        player.chips += c.diff; c.newTotal = player.chips; 
                    });
                    this.lastResult = { isWin, base, multiplier, finalUnit, changes };
                    fetch(CONFIG.GAS_URL, {
                        method: "POST", mode: "no-cors",
                        body: JSON.stringify({
                            action: "recordRound", gameId: this.gameId, round: this.roundCount,
                            dealer, friend, suit, bid, oppScore, result: isWin ? "ìŠ¹ë¦¬" : "íŒŒì•¡",
                            changesLog: changes.map(c => `${c.name}:${c.diff > 0 ? '+' : ''}${c.diff}`).join(', '), 
                            players: this.players
                        })
                    });
                    this.saveSession(); this.loading = false; this.step = 5;
                },
                revertResult() {
                    if(!confirm("ì •ì‚°ì„ ì·¨ì†Œí•˜ê³  ì´ì „ í™”ë©´ìœ¼ë¡œ ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                    this.lastResult.changes.forEach(c => {
                        const p = this.players.find(p => p.name === c.name);
                        if(p) p.chips -= c.diff; 
                    });
                    this.saveSession(); this.step = 4; 
                },
                nextRound() {
                    if (this.players.length === 6) {
                        if (this.lastResult.isWin) {
                            if (this.formData.friend !== 'ë…¸í”„ë Œë“œ') this.standbyPlayer = this.formData.friend;
                        } else {
                            this.standbyPlayer = this.formData.dealer;
                        }
                    }
                    this.formData = { dealer: '', friend: '', suit: null, bid: null, oppScore: 0 };
                    this.roundCount++; this.saveSession(); this.step = 3;
                }
            },
            mounted() { this.fetchPlayers(); }
        }).mount('#app')
    </script>
</body>
</html>