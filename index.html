<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mighty Master</title>
    <script src="config.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; overflow-y: hidden; }
        [v-cloak] { display: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ë¹„ë”© ìˆ«ì ì• ë‹ˆë©”ì´ì…˜ */
        .chip-change { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes pop { 0% { transform: translateY(10px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }

        /* ë¹„ë”© ì¹¸ ê³ ì • ë°°ê²½ ì²˜ë¦¬ */
        .sticky-suit {
            position: sticky;
            left: 0;
            z-index: 20;
            background-color: #f9fafb; /* gray-50 ìƒ‰ìƒê³¼ ì¼ì¹˜ì‹œì¼œ ë’¤ê°€ ì•ˆë³´ì´ê²Œ í•¨ */
            width: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-md mx-auto h-[100dvh] bg-white shadow-xl flex flex-col overflow-hidden relative border-x">
        
        <header class="bg-gray-900 text-white py-2.5 px-4 text-center shadow-md z-10 shrink-0 flex justify-between items-center">
            <h1 class="text-[10px] font-black italic tracking-tighter text-gray-500 uppercase">MIGHTY MASTER</h1>
            <button v-if="step > 2" @click="endGame" class="text-[11px] text-gray-300 font-bold border border-gray-600 px-3 py-1 rounded active:bg-gray-700">ê²Œì„ ì¢…ë£Œ</button>
        </header>

        <main class="flex-grow p-3 flex flex-col overflow-hidden">
            
            <section v-if="step === 1" class="flex-grow flex flex-col justify-center space-y-4">
                <button @click="step = 2" class="w-full p-8 rounded-3xl bg-white shadow-sm flex items-center justify-between border-2 border-gray-100">
                    <div class="text-left"><h3 class="text-xl font-black text-gray-800">ìƒˆ ê²Œì„ ì‹œì‘</h3></div>
                    <span class="text-4xl">ğŸƒ</span>
                </button>
                <button v-if="hasSavedSession" @click="loadSession" class="w-full p-6 rounded-3xl bg-blue-50 border border-blue-200 flex items-center justify-between shadow-sm">
                    <div class="text-left"><h3 class="text-lg font-black text-blue-800">ì´ì „ ê²Œì„ ì´ì–´í•˜ê¸°</h3></div>
                    <span class="text-2xl">ğŸ”„</span>
                </button>
            </section>

            <section v-if="step === 2" class="flex flex-col h-full space-y-3">
                <div class="flex justify-between items-center pb-1 border-b shrink-0">
                    <h2 class="text-xl font-black text-gray-800">ì¸ì› ì„ íƒ (5~6ëª…)</h2>
                    <span :class="['font-black text-sm', selectedPlayers.length >= 5 ? 'text-blue-600' : 'text-red-500']">{{ selectedPlayers.length }} ëª…</span>
                </div>
                <div class="grid grid-cols-2 gap-2 flex-grow overflow-y-auto p-1">
                    <button v-for="(name, idx) in playerList.slice(1)" :key="name" @click="togglePlayer(name)"
                        :class="['p-4 rounded-xl border-2 text-sm font-bold transition-all flex items-center justify-center gap-2', selectedPlayers.includes(name) ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-gray-100 bg-white text-gray-400 shadow-sm']">
                        <span v-if="selectedPlayers.includes(name)" class="text-[10px] bg-blue-600 text-white rounded px-1.5 py-0.5 font-black">{{ selectedPlayers.indexOf(name) + 1 }}</span>
                        {{ name }}
                    </button>
                </div>
                <div class="bg-gray-100 p-2 rounded-2xl flex gap-2 shrink-0">
                    <input v-model="newPlayerName" @keyup.enter="addPlayer" class="flex-grow bg-transparent px-3 text-sm outline-none font-bold" placeholder="ì‹ ê·œ ë©¤ë²„...">
                    <button @click="addPlayer" class="bg-white px-4 py-2 rounded-xl text-xs font-black shadow-sm">ë“±ë¡</button>
                </div>
                <button @click="startGame" :disabled="selectedPlayers.length < 5" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black text-lg shadow-lg disabled:bg-gray-200">
                    {{ selectedPlayers.length === 6 ? '6ë§ˆ ì‹œì‘' : '5ë§ˆ ì‹œì‘' }}
                </button>
            </section>

            <section v-if="step === 3" class="flex flex-col h-full space-y-1.5 relative overflow-hidden">
                <div class="flex justify-between items-center px-1 shrink-0"><h2 class="text-sm font-black text-gray-800">Round {{ roundCount }} ë¹„ë”©</h2></div>

                <div class="shrink-0 bg-blue-50 p-2.5 rounded-xl border border-blue-100 shadow-sm">
                    <div class="flex justify-between items-center mb-1.5">
                        <label class="text-[11px] font-black text-blue-600 uppercase ml-1">ì£¼ê³µ ì„ íƒ</label>
                        <button v-if="players.length === 6" @click="showStandbyModal = true" class="text-[11px] bg-white border-2 border-blue-200 text-blue-600 px-3 py-1 rounded-lg font-black shadow-sm active:bg-blue-600 active:text-white transition-colors">
                            íœ´ì‹ ì§€ì • âš™ï¸
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-1.5">
                        <button v-for="p in players" :key="p.name" @click="selectDealer(p.name)" :disabled="standbyPlayer === p.name"
                            :class="['p-2 rounded-xl border-2 flex flex-col items-center justify-center transition-all relative min-h-[58px]', standbyPlayer === p.name ? 'opacity-20' : formData.dealer === p.name ? 'border-blue-600 bg-white' : 'border-gray-100 bg-white shadow-sm']">
                            <span v-if="standbyPlayer === p.name" class="absolute top-1 left-1 bg-red-500 text-white text-[8px] px-1.5 rounded font-black">íœ´ì‹</span>
                            <span class="text-xs font-black">{{ p.name }}</span>
                            <span :class="['text-[13px] font-black mt-0.5', getChipColor(p.chips)]">{{ p.chips }}</span>
                        </button>
                    </div>
                </div>

                <div class="flex-grow bg-gray-50 rounded-2xl border p-1 overflow-hidden flex flex-col">
                    <div class="flex-grow overflow-x-auto hide-scrollbar overflow-y-hidden">
                        <div class="min-w-max flex flex-col gap-2 py-2 pr-16">
                            <div v-for="s in suits" :key="s.name" class="flex items-center">
                                <div :class="['sticky-suit text-2xl font-black', s.textColor]">{{ s.symbol }}</div>
                                <div :class="['flex gap-2.5 transition-all', s.name === 'ë…¸ê¸°ë£¨' ? 'translate-x-5' : '']">
                                    <button v-for="num in bids" :key="num" @click="formData.suit = s.name; formData.bid = num"
                                        :class="['w-10 h-10 rounded-full border-2 font-black text-sm transition-all flex shrink-0 items-center justify-center shadow-sm', 
                                        formData.suit === s.name && formData.bid === num ? 'bg-gray-800 text-white border-gray-800 scale-110' : 'bg-white border-gray-200 ' + s.textColor]">{{ num }}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-2.5 bg-white border border-gray-200 rounded-xl shadow-sm shrink-0">
                    <div class="flex justify-between items-center mb-1 pb-1 border-b border-gray-100">
                        <span class="text-[9px] font-black text-gray-400 uppercase">í˜„ì¬ ë¹„ë”©</span>
                        <span v-if="formData.suit && formData.bid" :class="['text-base font-black', currentSuit.textColor]">
                            {{ formData.suit }} {{ formData.bid }} <span class="ml-1 text-gray-400 font-bold">({{ bidAlias }})</span>
                        </span>
                        <span v-else class="text-[10px] text-gray-300 font-bold">ê¸°ë£¨ì™€ ìˆ«ìë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
                    </div>
                    <div class="flex justify-between items-center px-1">
                        <p class="text-[10px] font-black text-gray-500">ë§ˆì´í‹° <span :class="['text-[11px] ml-1 font-black', calculateMighty.color]">{{ calculateMighty.text }}</span></p>
                        <p class="text-[10px] font-black text-gray-500">ì¡°ì»¤ ì½œ <span class="text-[11px] ml-1 font-black text-gray-800">{{ calculateJokerCall.text }}</span></p>
                    </div>
                </div>

                <button @click="step = 4" :disabled="!isBiddingComplete" class="shrink-0 w-full py-4 bg-blue-600 text-white rounded-2xl font-black text-base shadow-lg disabled:bg-gray-200 transition-all">
                    {{ roundStartButtonText }}
                </button>

                <div v-if="showStandbyModal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-6">
                    <div class="bg-white rounded-[2.5rem] w-full max-w-xs p-6 shadow-2xl">
                        <h3 class="font-black text-center text-lg text-gray-800 mb-5">ì´ë²ˆ íŒ íœ´ì‹ ì¸ì›</h3>
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <button v-for="p in players" :key="p.name" @click="setStandby(p.name)" 
                                :class="['p-4 border-2 rounded-2xl font-black text-sm transition-all shadow-sm', standbyPlayer === p.name ? 'border-blue-600 bg-blue-50 text-blue-600' : 'border-gray-100 bg-white text-gray-700']">{{ p.name }}</button>
                            <button @click="setStandby(null)" class="col-span-2 p-3 border-2 rounded-2xl font-black text-sm bg-gray-50 text-gray-400">ì „ì› ì°¸ì—¬</button>
                        </div>
                        <button @click="showStandbyModal = false" class="w-full py-4 bg-gray-900 text-white font-black rounded-2xl shadow-lg">ë‹«ê¸°</button>
                    </div>
                </div>
            </section>

            <section v-if="step === 4" class="flex flex-col h-full space-y-2.5 relative overflow-hidden">
                <div class="grid grid-cols-2 gap-2 shrink-0">
                    <div class="bg-white border-2 border-gray-100 rounded-2xl py-2 px-3 flex flex-col items-center justify-center shadow-sm">
                        <span :class="['text-2xl font-black', calculateMighty.color]">{{ calculateMighty.text }}</span>
                        <span class="text-[8px] font-black text-gray-300 uppercase mt-0.5">ë§ˆì´í‹°</span>
                    </div>
                    <div class="bg-white border-2 border-gray-100 rounded-2xl py-2 px-3 flex flex-col items-center justify-center shadow-sm">
                        <span class="text-2xl font-black text-gray-800">{{ calculateJokerCall.text }}</span>
                        <span class="text-[8px] font-black text-gray-300 uppercase mt-0.5">ì¡°ì»¤ì½œ</span>
                    </div>
                </div>

                <div class="bg-blue-50 p-2.5 rounded-2xl border border-blue-100 shrink-0 shadow-sm">
                    <div class="flex justify-between items-center mb-1.5 px-1">
                        <label class="text-[10px] font-black text-blue-600 uppercase">í”„ë Œë“œ ì„ íƒ</label>
                        <button @click="formData.friend = 'ë…¸í”„ë Œë“œ'" :class="['text-[9px] px-2.5 py-1 rounded-md font-black border transition-all shadow-sm', formData.friend === 'ë…¸í”„ë Œë“œ' ? 'bg-red-500 text-white' : 'bg-white text-gray-500']">ë…¸í”„ë Œë“œ ğŸš«</button>
                    </div>
                    <div class="grid grid-cols-3 gap-1">
                        <button v-for="p in players" :key="p.name" @click="formData.friend = p.name"
                            :disabled="p.name === formData.dealer || standbyPlayer === p.name"
                            :class="['p-2 rounded-xl border-2 flex flex-col items-center justify-center transition-all relative min-h-[60px]', 
                                standbyPlayer === p.name ? 'opacity-20 bg-gray-100' : p.name === formData.dealer ? 'bg-gray-100 opacity-60' : 
                                formData.friend === p.name ? 'border-blue-600 bg-white text-blue-700 shadow-md ring-1' : 'border-gray-100 bg-white shadow-sm']">
                            <span v-if="p.name === formData.dealer" class="absolute top-1 right-1 bg-amber-500 text-white text-[7px] font-black px-1 rounded shadow-sm">ì£¼ê³µ</span>
                            <span v-if="standbyPlayer === p.name" class="absolute top-1 left-1 bg-red-500 text-white text-[7px] font-black px-1 rounded shadow-sm">íœ´ì‹</span>
                            <span class="text-xs font-black tracking-tighter">{{ p.name }}</span>
                            <span :class="['text-[13px] font-black mt-0.5', getChipColor(p.chips)]">{{ p.chips }}</span>
                        </button>
                    </div>
                </div>

                <div class="flex-grow flex flex-col justify-center space-y-3 px-1">
                    <div class="flex items-center justify-between px-6 py-3 bg-white rounded-xl border-2 border-gray-900 shadow-md shrink-0">
                        <div class="flex items-center gap-3">
                            <span :class="['text-3xl font-black', currentSuit.textColor]">{{ currentSuit.symbol }}</span>
                            <span class="text-2xl font-black text-gray-900">{{ formData.bid }} <span class="text-[11px] text-gray-400 font-bold">({{ bidAlias }})</span></span>
                        </div>
                        <div class="text-right">
                            <p class="text-[8px] font-black text-gray-400 mb-0.5 uppercase tracking-tighter">ì•¼ë‹¹ ëª©í‘œ</p>
                            <p class="text-lg font-black text-red-600">{{ 21 - formData.bid }}ì¥ ì´ìƒ</p>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-[2rem] border-2 border-gray-100 flex flex-col items-center shadow-sm">
                        <div class="flex justify-between w-full items-center mb-3 px-1">
                            <span class="text-[9px] font-black text-gray-400 uppercase tracking-widest">ì•¼ë‹¹ íšë“ ì¥ìˆ˜</span>
                            <span :class="['px-3 py-0.5 rounded-full text-[9px] font-black text-white shadow-sm', isCurrentBidSuccess ? 'bg-green-500' : 'bg-red-500']">{{ isCurrentBidSuccess ? 'ì—¬ë‹¹ ìŠ¹ë¦¬' : 'ì•¼ë‹¹ ìŠ¹ë¦¬' }}</span>
                        </div>
                        <div class="flex items-center justify-center gap-10 w-full mb-3 shrink-0">
                            <button @click="formData.oppScore = Math.max(0, formData.oppScore - 1)" class="w-11 h-11 rounded-full bg-gray-50 border-2 text-2xl font-black text-gray-300">-</button>
                            <span class="text-7xl font-black w-24 text-center text-gray-800 tracking-tighter leading-none">{{ formData.oppScore }}</span>
                            <button @click="formData.oppScore = Math.min(20, formData.oppScore + 1)" class="w-11 h-11 rounded-full bg-gray-50 border-2 text-2xl font-black text-gray-300">+</button>
                        </div>
                        <input type="range" v-model.number="formData.oppScore" min="0" max="20" class="w-full accent-blue-600 h-2">
                    </div>
                </div>

                <div class="flex gap-2 shrink-0 pb-1">
                    <button @click="step = 3" class="flex-1 py-4 bg-gray-100 text-gray-400 rounded-2xl font-bold text-xs">ë¹„ë”© ìˆ˜ì •</button>
                    <button @click="calculateResult" :disabled="!formData.friend || loading" class="flex-[2] py-4 bg-gray-900 text-white rounded-2xl font-black text-lg shadow-xl active:scale-95 disabled:bg-gray-200">ì •ì‚°í•˜ê¸°</button>
                </div>
            </section>

            <section v-if="step === 5" class="flex flex-col h-full space-y-2 relative overflow-hidden">
                <div :class="['py-4 rounded-3xl text-center border-4 shrink-0 relative overflow-hidden shadow-md', lastResult.isWin ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200']">
                    <button @click="revertResult" class="absolute top-2 left-2 text-[10px] font-bold text-gray-400 bg-white/80 px-2 py-0.5 rounded border shadow-sm">â¬…ï¸ ì·¨ì†Œ</button>
                    <h2 :class="['text-3xl font-black mt-2', lastResult.isWin ? 'text-green-600' : 'text-red-600']">{{ lastResult.isWin ? 'ì—¬ë‹¹ ìŠ¹ë¦¬ ğŸ‰' : 'ì•¼ë‹¹ ìŠ¹ë¦¬ ğŸ’€' }}</h2>
                    <p class="text-[11px] font-bold text-gray-500 mt-1">{{ formData.suit }} {{ formData.bid }} | ì•¼ë‹¹ {{ formData.oppScore }}ì¥</p>
                    <div class="mt-2 inline-flex items-center bg-white px-4 py-1.5 rounded-full shadow-sm border">
                        <span class="text-[9px] font-black text-gray-300 mr-2 uppercase tracking-widest">{{ lastResult.base }}Ã—{{ lastResult.multiplier }}</span>
                        <span class="text-base font-black text-blue-600">{{ lastResult.finalUnit }} ì </span>
                    </div>
                </div>

                <div class="flex-grow bg-white rounded-2xl border p-1 space-y-0.5 overflow-hidden flex flex-col justify-between">
                    <div v-for="change in lastResult.changes" :key="change.name" 
                        :class="['flex justify-between items-center px-4 py-2.5 rounded-xl chip-change border-b last:border-0', change.role === 'íœ´ì‹' ? 'bg-gray-50 opacity-40' : 'bg-white shadow-sm']">
                        <div class="flex items-center gap-3">
                            <span class="font-black text-gray-800 text-sm min-w-[50px] leading-tight">{{ change.name }}</span>
                            <span v-if="change.role" class="text-[8px] font-bold text-white px-2 py-0.5 rounded shadow-sm" :class="change.role === 'íœ´ì‹' ? 'bg-gray-300' : change.role.includes('ì£¼ê³µ') ? 'bg-blue-600' : (change.role === 'í”„ë Œë“œ' ? 'bg-blue-400' : 'bg-gray-400')">{{ change.role }}</span>
                        </div>
                        <div class="flex items-center gap-5 text-right">
                            <div class="flex flex-col items-end">
                                <span class="text-[7px] text-gray-300 font-bold uppercase tracking-tighter">ì´ì „/ë³€ë™</span>
                                <div class="text-[12px] font-bold text-gray-400 leading-none">
                                    {{ change.oldTotal }} <span :class="['ml-1', change.diff > 0 ? 'text-green-500' : change.diff < 0 ? 'text-red-500' : 'text-gray-300']">{{ change.diff >= 0 ? '+' : '' }}{{ change.diff }}</span>
                                </div>
                            </div>
                            <div class="flex flex-col items-end min-w-[55px]">
                                <span class="text-[7px] text-gray-400 font-bold uppercase tracking-tighter">ë³´ìœ  ì ìˆ˜</span>
                                <span :class="['font-black text-2xl tracking-tighter leading-none', getChipColor(change.newTotal)]">{{ change.newTotal }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="shrink-0 pb-1.5 pt-1">
                    <button @click="nextRound" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-black text-lg active:scale-95 transition-all shadow-xl">ë‹¤ìŒ íŒ ë¹„ë”©í•˜ê¸°</button>
                </div>
            </section>
        </main>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    step: 1, playerList: [], selectedPlayers: [], players: [],
                    standbyPlayer: null, showStandbyModal: false, newPlayerName: '',
                    loading: false, isAddingPlayer: false, gameId: '', roundCount: 1,
                    suits: [
                        { symbol: 'N', name: 'ë…¸ê¸°ë£¨', textColor: 'text-gray-400', alias: 'ë…¸' },
                        { symbol: 'â™ ', name: 'ìŠ¤í˜ì´ë“œ', textColor: 'text-gray-900', alias: 'ì‚½' },
                        { symbol: 'â™¦', name: 'ë‹¤ì´ì•„', textColor: 'text-red-600', alias: 'ë‹¤ë¦¬' },
                        { symbol: 'â™£', name: 'í´ë¡œë²„', textColor: 'text-gray-900', alias: 'ëŒ' },
                        { symbol: 'â™¥', name: 'í•˜íŠ¸', textColor: 'text-red-600', alias: 'íŠ¸' }
                    ],
                    bids: [11, 12, 13, 14, 15, 16, 17, 18, 19, 20],
                    numAliases: { 11:'ê¸°', 12:'ë‘˜', 13:'ì…‹', 14:'ë„·', 15:'ë‹·', 16:'ì—¿', 17:'ê³±', 18:'ëœ', 19:'í™‰', 20:'í’€' },
                    formData: { dealer: '', friend: '', suit: null, bid: null, oppScore: 0 },
                    lastResult: {}
                }
            },
            computed: {
                hasSavedSession() { return localStorage.getItem('mightySession') !== null; },
                activePlayers() { return this.players.filter(p => p.name !== this.standbyPlayer); },
                roundStartButtonText() {
                    let missing = [];
                    if (this.players.length === 6 && !this.standbyPlayer) missing.push('íœ´ì‹');
                    if (!this.formData.dealer) missing.push('ì£¼ê³µ');
                    if (!this.formData.suit || !this.formData.bid) missing.push('ë¹„ë”©');
                    return missing.length === 0 ? "ë¼ìš´ë“œ ì‹œì‘" : `ë¼ìš´ë“œ ì‹œì‘ (${missing.join(', ')})`;
                },
                isBiddingComplete() { return this.formData.dealer && this.formData.suit && this.formData.bid && (this.players.length !== 6 || this.standbyPlayer); },
                currentSuit() { return this.suits.find(s => s.name === this.formData.suit) || { symbol: '?', textColor: 'text-gray-200' }; },
                isCurrentBidSuccess() { return (20 - this.formData.oppScore) >= (this.formData.bid || 0); },
                bidAlias() {
                    if (!this.formData.suit || !this.formData.bid) return "";
                    const s = this.suits.find(x => x.name === this.formData.suit).alias;
                    const n = this.numAliases[this.formData.bid];
                    return n + s;
                },
                calculateMighty() { 
                    if (!this.formData.suit) return { text: '-', color: 'text-gray-300' };
                    return this.formData.suit === 'ìŠ¤í˜ì´ë“œ' ? { text: 'â™¦A', color: 'text-red-600' } : { text: 'â™ A', color: 'text-gray-900' };
                },
                calculateJokerCall() {
                    if (!this.formData.suit) return { text: '-', color: 'text-gray-300' };
                    return this.formData.suit === 'í´ë¡œë²„' ? { text: 'â™ 3', color: 'text-gray-900' } : { text: 'â™£3', color: 'text-gray-900' }; 
                }
            },
            methods: {
                getChipColor(chips) {
                    if (chips === 40) return 'text-black';
                    if (chips < 40) {
                        const intensity = Math.max(300, 900 - (chips * 12)); 
                        return `text-red-${Math.round(intensity/100)*100}`;
                    }
                    return 'text-blue-600';
                },
                togglePlayer(name) {
                    const idx = this.selectedPlayers.indexOf(name);
                    idx > -1 ? this.selectedPlayers.splice(idx, 1) : this.selectedPlayers.length < 6 && this.selectedPlayers.push(name);
                },
                async fetchPlayers() { try { const res = await fetch(CONFIG.GAS_URL); const data = await res.json(); this.playerList = data.players || []; } catch(e) {} },
                async addPlayer() {
                    if(!this.newPlayerName) return; this.playerList.push(this.newPlayerName); this.togglePlayer(this.newPlayerName);
                    fetch(CONFIG.GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "addPlayer", name: this.newPlayerName }) });
                    this.newPlayerName = '';
                },
                selectDealer(name) { if(this.standbyPlayer !== name) this.formData.dealer = name; },
                setStandby(name) { 
                    this.standbyPlayer = name; 
                    if(this.formData.dealer === name) this.formData.dealer = '';
                    this.showStandbyModal = false; this.saveSession(); 
                },
                async startGame() {
                    this.loading = true; this.gameId = `M_${Date.now()}`; this.roundCount = 1; this.players = this.selectedPlayers.map(name => ({ name, chips: 40 }));
                    fetch(CONFIG.GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "startGame", gameId: this.gameId, players: this.players }) });
                    this.saveSession(); this.step = 3; this.loading = false;
                },
                saveSession() { localStorage.setItem('mightySession', JSON.stringify({ gameId: this.gameId, roundCount: this.roundCount, players: this.players, standbyPlayer: this.standbyPlayer })); },
                loadSession() { const d = JSON.parse(localStorage.getItem('mightySession')); this.gameId=d.gameId; this.roundCount=d.roundCount; this.players=d.players; this.standbyPlayer=d.standbyPlayer; this.selectedPlayers=this.players.map(p=>p.name); this.step=3; },
                endGame() { 
                    if(confirm("ê²Œì„ì„ ì¢…ë£Œí•˜ê³  ëª¨ë“  ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        localStorage.removeItem('mightySession'); 
                        this.standbyPlayer = null; this.formData = { dealer: '', friend: '', suit: null, bid: null, oppScore: 0 };
                        this.selectedPlayers = []; this.step = 1; 
                    } 
                },
                async calculateResult() {
                    this.loading = true;
                    const { dealer, friend, suit, bid, oppScore } = this.formData;
                    const wonCards = 20 - oppScore; const isWin = wonCards >= bid;
                    const isRun = (oppScore === 0); const isBackrun = (oppScore >= 10);
                    let base = 0;
                    if (bid === 20) base = isWin || isBackrun ? 20 : Math.ceil((bid - wonCards) * 1.5);
                    else base = isWin ? (isRun ? 15 : wonCards - 10) : (isBackrun ? 15 : bid - wonCards);
                    const multiplier = (suit === 'ë…¸ê¸°ë£¨' ? 2 : 1) * (friend === 'ë…¸í”„ë Œë“œ' ? 2 : 1);
                    const finalUnit = base * multiplier;
                    let changes = this.players.map(p => {
                        const oldTotal = p.chips;
                        let role = 'ì•¼ë‹¹'; let diff = 0;
                        if (p.name === this.standbyPlayer) { role = 'íœ´ì‹'; diff = 0; }
                        else if (p.name === dealer) { role = friend === 'ë…¸í”„ë Œë“œ' ? 'ì£¼ê³µ(ë…¸í”„)' : 'ì£¼ê³µ'; diff = isWin ? (friend === 'ë…¸í”„ë Œë“œ' ? finalUnit * 4 : finalUnit * 2) : (friend === 'ë…¸í”„ë Œë“œ' ? -finalUnit * 4 : -finalUnit * 2); }
                        else if (p.name === friend) { role = 'í”„ë Œë“œ'; diff = isWin ? finalUnit : -finalUnit; }
                        else { diff = isWin ? -finalUnit : finalUnit; }
                        p.chips += diff;
                        return { name: p.name, role, diff, oldTotal, newTotal: p.chips };
                    });
                    this.lastResult = { isWin, base, multiplier, finalUnit, changes };
                    fetch(CONFIG.GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "recordRound", gameId: this.gameId, round: this.roundCount, dealer, friend, suit, bid, oppScore, result: isWin ? "ìŠ¹ë¦¬" : "íŒŒì•¡", changesLog: changes.map(c=>`${c.name}:${c.diff}`).join(','), players: this.players }) });
                    this.saveSession(); this.loading = false; this.step = 5;
                },
                revertResult() {
                    if(!confirm("ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                    this.lastResult.changes.forEach(c => { const p = this.players.find(x => x.name === c.name); if(p) p.chips -= c.diff; });
                    this.saveSession(); this.step = 4; 
                },
                nextRound() {
                    if (this.players.length === 6) {
                        if (this.lastResult.isWin) { if (this.formData.friend !== 'ë…¸í”„ë Œë“œ') this.standbyPlayer = this.formData.friend; }
                        else { this.standbyPlayer = this.formData.dealer; }
                    }
                    this.formData = { dealer: '', friend: '', suit: null, bid: null, oppScore: 0 };
                    this.roundCount++; this.saveSession(); this.step = 3;
                }
            },
            mounted() { this.fetchPlayers(); }
        }).mount('#app')
    </script>
</body>
</html>