<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mighty Master</title>
    <script src="config.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; overflow-y: hidden; }
        .menu-card { transition: all 0.2s; border: 1px solid #e5e7eb; }
        .menu-card:active { transform: scale(0.95); background-color: #f9fafb; }
        [v-cloak] { display: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .chip-change { animation: pop 0.3s ease-out forwards; }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-md mx-auto h-[100dvh] bg-white shadow-xl flex flex-col overflow-hidden relative">
        
        <header class="bg-gray-900 text-white py-3 px-4 text-center shadow-md z-10 shrink-0 flex justify-between items-center">
            <h1 class="text-lg font-black italic tracking-tighter">MIGHTY MASTER</h1>
            <button v-if="step > 2" @click="endGame" class="text-xs text-red-400 font-bold border border-red-400 px-2 py-1 rounded hover:bg-red-500 hover:text-white transition-colors">ê²Œì„ ì¢…ë£Œ</button>
        </header>

        <main class="flex-grow p-4 flex flex-col overflow-y-auto">
            
            <section v-if="step === 1" class="flex-grow flex flex-col justify-center space-y-4">
                <div class="text-center mb-6">
                    <p class="text-gray-400 text-xs font-bold uppercase tracking-widest">Welcome</p>
                    <h2 class="text-2xl font-black text-gray-800">ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</h2>
                </div>
                
                <button v-if="hasSavedSession" @click="loadSession" class="menu-card w-full p-5 rounded-[1.5rem] bg-blue-50 border-blue-200 shadow-sm flex items-center justify-between group">
                    <div class="text-left">
                        <h3 class="text-lg font-black text-blue-800">ì´ì „ ê²Œì„ ì´ì–´ì„œ í•˜ê¸°</h3>
                        <p class="text-xs text-blue-500">ì €ì¥ëœ ì„¸ì…˜ì´ ìˆìŠµë‹ˆë‹¤</p>
                    </div>
                    <span class="text-2xl">ğŸ”„</span>
                </button>

                <button @click="step = 2" class="menu-card w-full p-6 rounded-[1.5rem] bg-white shadow-sm flex items-center justify-between group">
                    <div class="text-left">
                        <h3 class="text-lg font-black text-gray-800">ìƒˆ ê²Œì„ ì‹œì‘</h3>
                        <p class="text-xs text-gray-400">ì¸ì›(5~6ëª…) ì„ íƒ ë° ë¹„ë”©</p>
                    </div>
                    <span class="text-3xl">ğŸƒ</span>
                </button>
            </section>

            <section v-if="step === 2" class="flex flex-col h-full space-y-4">
                <div class="flex justify-between items-center pb-2 border-b">
                    <h2 class="text-xl font-black text-gray-800">ì¸ì› ì„ íƒ (5~6ëª…)</h2>
                    <span :class="['font-black text-sm', selectedPlayers.length >= 5 && selectedPlayers.length <= 6 ? 'text-blue-600' : 'text-red-500']">
                        {{ selectedPlayers.length }} ëª…
                    </span>
                </div>
                
                <div v-if="playerList.length === 0" class="text-center text-gray-400 text-sm py-4">
                    ë¶ˆëŸ¬ì˜¬ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ì—ì„œ ë©¤ë²„ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.
                </div>

                <div class="grid grid-cols-2 gap-2 max-h-[40vh] overflow-y-auto p-1">
                    <button v-for="name in playerList" :key="name" 
                        @click="togglePlayer(name)"
                        :class="['p-3 rounded-xl border-2 text-sm font-bold transition-all flex items-center justify-center gap-2', 
                                 selectedPlayers.includes(name) ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-gray-100 bg-white text-gray-400']">
                        <span v-if="selectedPlayers.includes(name)" class="text-xs bg-blue-600 text-white rounded-md px-1.5 py-0.5 font-black">
                            {{ selectedPlayers.indexOf(name) + 1 }}
                        </span>
                        {{ name }}
                    </button>
                </div>

                <div class="bg-gray-100 p-2 rounded-xl flex gap-2 shrink-0">
                    <input v-model="newPlayerName" @keyup.enter="addPlayer" class="flex-grow bg-transparent px-3 text-sm outline-none" placeholder="ì‹ ê·œ ë©¤ë²„ ì¶”ê°€...">
                    <button @click="addPlayer" :disabled="isAddingPlayer" class="bg-white px-3 py-2 rounded-lg text-xs font-black shadow-sm disabled:opacity-50">ë“±ë¡</button>
                </div>

                <div class="mt-auto pt-2 shrink-0 space-y-2">
                    <button @click="startGame" :disabled="selectedPlayers.length < 5 || selectedPlayers.length > 6 || loading"
                        class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black text-base shadow-lg disabled:bg-gray-200 transition-colors">
                        {{ loading ? 'ì„œë²„ í†µì‹  ì¤‘...' : (selectedPlayers.length === 6 ? '6ì¸ (íœ´ì‹ í¬í•¨) ëª¨ë“œë¡œ ì‹œì‘' : '5ì¸ ëª¨ë“œë¡œ ì‹œì‘') }}
                    </button>
                    <button @click="step = 1" class="w-full py-3 text-gray-400 font-bold text-sm">ì·¨ì†Œ</button>
                </div>
            </section>

            <section v-if="step === 3" class="flex flex-col h-full space-y-3 relative">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-black text-gray-800">Round {{ roundCount }} ë¹„ë”©</h2>
                </div>

                <div class="space-y-2 shrink-0 bg-blue-50 p-3 rounded-xl border border-blue-100">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[12px] font-black text-blue-600 uppercase tracking-widest ml-1">ì£¼ê³µ ì„ íƒ</label>
                        <button v-if="players.length === 6" @click="showStandbyModal = true" class="text-[10px] bg-white border border-gray-300 text-gray-700 px-2 py-1.5 rounded-lg shadow-sm font-bold active:bg-gray-100 transition-colors">
                            íœ´ì‹ ì§€ì • âš™ï¸
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2">
                        <button v-for="p in players" :key="p.name" @click="selectDealer(p.name)"
                            :disabled="standbyPlayer === p.name"
                            :class="[
                                'p-2 rounded-xl border-2 flex flex-col items-center justify-center transition-all relative overflow-hidden',
                                standbyPlayer === p.name ? 'bg-gray-200 border-gray-300 opacity-60 grayscale cursor-not-allowed' :
                                formData.dealer === p.name ? 'border-blue-600 bg-white text-blue-700 shadow-md ring-2 ring-blue-100' : 'border-gray-200 bg-white text-gray-700 shadow-sm hover:border-blue-300 cursor-pointer'
                            ]">
                            <span class="text-xs font-black">{{ p.name }}</span>
                            <span :class="['text-base font-black mt-0.5', p.chips < 0 ? 'text-red-500' : 'text-gray-900']">{{ p.chips }}</span>
                            
                            <div v-if="standbyPlayer === p.name" class="absolute inset-0 flex items-center justify-center bg-black/5">
                                <span class="text-[11px] font-black text-gray-500 bg-white/90 px-1.5 py-0.5 rounded rotate-[-15deg] border border-gray-400 shadow-sm">íœ´ì‹</span>
                            </div>
                        </button>
                    </div>
                </div>

                <div class="space-y-1.5 flex-grow flex flex-col overflow-hidden min-h-[220px]">
                    <div class="bg-gray-50 py-2 pr-2 pl-0 rounded-2xl border border-gray-200 overflow-x-auto hide-scrollbar flex-grow relative">
                        <div class="min-w-max flex flex-col gap-2 py-1">
                            <div v-for="s in suits" :key="s.name" class="flex items-center">
                                <div :class="['sticky left-0 bg-gray-50 w-12 h-10 flex items-center justify-center font-black text-[24px] shrink-0 z-30 shadow-[4px_0_8px_-6px_rgba(0,0,0,0.2)]', s.textColor]">
                                    {{ s.symbol }}
                                </div>
                                <div class="flex gap-2.5 ml-1 pr-8 relative z-0">
                                    <button v-for="num in bids" :key="num"
                                        @click="formData.suit = s.name; formData.bid = num"
                                        :class="[
                                            'w-10 h-10 rounded-full border-[3px] font-black text-sm transition-all flex shrink-0 items-center justify-center', 
                                            formData.suit === s.name && formData.bid === num 
                                                ? 'bg-gray-800 text-white border-gray-800 scale-110 shadow-md z-20' 
                                                : 'bg-white hover:bg-gray-100 ' + s.borderColor + ' ' + s.textColor,
                                            (s.name === 'ë…¸ê¸°ë£¨' || num === 20) ? 'translate-x-[22px]' : ''
                                        ]">
                                        {{ num }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-3 bg-white border border-gray-200 rounded-xl shadow-sm shrink-0">
                    <div class="flex justify-between items-center mb-1 pb-1 border-b border-gray-100">
                        <span class="text-xs font-black text-gray-500">í˜„ì¬ ë¹„ë”©</span>
                        <span v-if="formData.suit && formData.bid" class="text-lg font-black text-blue-600">
                            {{ formData.suit }} {{ formData.bid }}
                        </span>
                        <span v-else class="text-xs text-gray-400">ì„ íƒ ëŒ€ê¸°</span>
                    </div>
                    <div class="flex justify-between items-center px-1">
                        <p class="text-[10px] font-black text-gray-400 uppercase tracking-tighter">Mighty 
                            <span :class="['text-xs ml-1 font-black', calculateMighty.color]">{{ calculateMighty.text }}</span>
                        </p>
                        <p class="text-[10px] font-black text-gray-400 uppercase tracking-tighter">Joker Call 
                            <span :class="['text-xs ml-1 font-black', calculateJokerCall.color]">{{ calculateJokerCall.text }}</span>
                        </p>
                    </div>
                </div>

                <div class="shrink-0 pt-1">
                    <button @click="step = 4" :disabled="!formData.dealer || !formData.suit || !formData.bid"
                        class="w-full py-4 bg-blue-600 text-white rounded-[1.5rem] font-black text-base shadow-lg disabled:bg-gray-200 disabled:text-gray-400 transition-colors">
                        ë¼ìš´ë“œ ì‹œì‘
                    </button>
                </div>
                
                <div v-if="showStandbyModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-5">
                    <div class="bg-white rounded-[2rem] w-full max-w-sm p-6 space-y-5 shadow-2xl">
                        <h3 class="text-xl font-black text-gray-800 text-center">íœ´ì‹ ë©¤ë²„ ì§€ì •</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button v-for="p in players" :key="p.name" @click="setStandby(p.name)"
                                :class="['p-4 border-2 rounded-xl font-black text-sm transition-all', standbyPlayer === p.name ? 'border-blue-600 bg-blue-50 text-blue-600 shadow-inner' : 'border-gray-200 text-gray-700 bg-white hover:border-gray-300']">
                                {{ p.name }}
                            </button>
                            <button @click="setStandby(null)"
                                :class="['col-span-2 p-4 border-2 rounded-xl font-black text-sm transition-all', standbyPlayer === null ? 'border-blue-600 bg-blue-50 text-blue-600 shadow-inner' : 'border-gray-200 text-gray-500 bg-gray-50']">
                                ë¯¸ì„ íƒ (ì „ì› ì°¸ì—¬)
                            </button>
                        </div>
                        <button @click="showStandbyModal = false" class="w-full py-4 bg-gray-900 text-white font-black text-base rounded-2xl active:scale-95 transition-transform">ë‹«ê¸°</button>
                    </div>
                </div>
            </section>

            <section v-if="step === 4" class="flex flex-col h-full space-y-4">
                <div class="bg-gray-900 p-5 rounded-3xl shadow-xl relative text-center shrink-0">
                    <div class="grid grid-cols-2 gap-3 relative z-10">
                        <div class="bg-white py-3 rounded-xl shadow-inner flex flex-col items-center justify-center">
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-tighter mb-0.5">Mighty</p>
                            <p :class="['text-2xl font-black', calculateMighty.color]">{{ calculateMighty.text }}</p>
                        </div>
                        <div class="bg-white py-3 rounded-xl shadow-inner flex flex-col items-center justify-center">
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-tighter mb-0.5">Joker Call</p>
                            <p :class="['text-2xl font-black', calculateJokerCall.color]">{{ calculateJokerCall.text }}</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-800 text-gray-400 flex justify-between items-center px-2">
                        <p class="text-sm"><span class="text-white font-bold">{{ formData.dealer }}</span> ì£¼ê³µ ({{ formData.suit }} {{ formData.bid }})</p>
                        <p class="text-xs">ì•¼ë‹¹ ëª©í‘œ: <span class="text-red-500 font-bold">{{ 21 - formData.bid }}ì¥</span></p>
                    </div>
                </div>

                <div class="flex-grow space-y-3">
                    <div class="bg-gray-50 p-3 rounded-2xl border border-gray-200">
                        <label class="block text-[10px] font-black text-gray-400 mb-2 ml-1 uppercase">í”„ë Œë“œ (Friend)</label>
                        <div class="grid grid-cols-5 gap-1">
                            <button v-for="name in potentialFriends" :key="name" @click="formData.friend = name"
                                :class="['p-2 rounded-lg border-2 text-xs font-bold transition-all break-keep', 
                                        formData.friend === name ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-gray-100 bg-white text-gray-500']">
                                {{ name }}
                            </button>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-2xl border border-gray-200 flex flex-col items-center">
                        <label class="block text-[10px] font-black text-gray-400 mb-3 text-center uppercase tracking-wider">Opponent Score (ì•¼ë‹¹ íšë“ ì¥ìˆ˜)</label>
                        <div class="flex items-center justify-center gap-6 w-full mb-3">
                            <button @click="formData.oppScore = Math.max(0, formData.oppScore - 1)" 
                                    class="w-12 h-12 rounded-full bg-white shadow-sm border border-gray-200 text-2xl font-black text-gray-600 active:scale-95 flex items-center justify-center pb-1">-</button>
                            <span class="text-5xl font-black w-16 text-center text-gray-800">{{ formData.oppScore }}</span>
                            <button @click="formData.oppScore = Math.min(20, formData.oppScore + 1)" 
                                    class="w-12 h-12 rounded-full bg-white shadow-sm border border-gray-200 text-2xl font-black text-gray-600 active:scale-95 flex items-center justify-center pb-1">+</button>
                        </div>
                        <input type="range" v-model.number="formData.oppScore" min="0" max="20" class="w-full accent-blue-600 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer px-2">
                    </div>
                </div>

                <div class="flex gap-2 mt-auto shrink-0 pt-2">
                    <button @click="step = 3" class="flex-1 py-4 bg-gray-100 text-gray-500 rounded-2xl font-bold text-sm">ìˆ˜ì •</button>
                    <button @click="calculateResult" :disabled="!formData.friend || loading" class="flex-[2] py-4 bg-gray-900 text-white rounded-2xl font-black text-base active:scale-95 transition-transform disabled:bg-gray-300">
                        {{ loading ? 'ê¸°ë¡ ì €ì¥ ì¤‘...' : 'ì •ì‚° ë° ì„œë²„ ì €ì¥' }}
                    </button>
                </div>
            </section>

            <section v-if="step === 5" class="flex flex-col h-full space-y-4">
                <div :class="['py-6 rounded-[2rem] text-center transition-all border-4 shrink-0 shadow-lg relative overflow-hidden', 
                              lastResult.isWin ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200']">
                    <h2 :class="['text-3xl font-black mb-1', lastResult.isWin ? 'text-green-600' : 'text-red-600']">
                        {{ lastResult.isWin ? 'ì—¬ë‹¹ ìŠ¹ë¦¬ ğŸ‰' : 'ì•¼ë‹¹ íŒŒì•¡ ğŸ’€' }}
                    </h2>
                    <p class="text-sm font-bold text-gray-500">{{ formData.suit }} {{ formData.bid }} (ì•¼ë‹¹ {{ formData.oppScore }}ì¥)</p>
                    <div class="mt-4 inline-block bg-white px-4 py-2 rounded-full shadow-sm border border-gray-100">
                        <span class="text-xs font-bold text-gray-400 mr-2">ê¸°ë³¸ìœ ë‹› x ë°°ìˆ˜</span>
                        <span class="text-lg font-black text-gray-800">{{ lastResult.base }} Ã— {{ lastResult.multiplier }} = <span class="text-blue-600">{{ lastResult.finalUnit }}ê°œ</span></span>
                    </div>
                </div>

                <div class="flex-grow bg-white rounded-3xl shadow-sm border border-gray-100 p-4 space-y-3 overflow-y-auto">
                    <div v-for="change in lastResult.changes" :key="change.name" 
                         class="flex justify-between items-center p-3 rounded-xl bg-gray-50 chip-change">
                        <div class="flex items-center gap-2">
                            <span class="font-black text-gray-800 text-base">{{ change.name }}</span>
                            <span v-if="change.role" class="text-[10px] font-bold text-white px-2 py-0.5 rounded-full" 
                                  :class="change.role.includes('ì£¼ê³µ') ? 'bg-blue-600' : (change.role === 'í”„ë Œë“œ' ? 'bg-blue-400' : 'bg-gray-400')">
                                {{ change.role }}
                            </span>
                        </div>
                        <div class="text-right">
                            <p :class="['font-black text-xl', change.diff > 0 ? 'text-green-500' : 'text-red-500']">
                                {{ change.diff > 0 ? '+' : '' }}{{ change.diff }}
                            </p>
                            <p class="text-[10px] text-gray-400 font-bold mt-0.5">ì´ ğŸª™ {{ change.newTotal }}</p>
                        </div>
                    </div>
                </div>

                <div class="mt-auto shrink-0 pt-2">
                    <button @click="nextRound" class="w-full py-4 bg-gray-900 text-white rounded-[1.5rem] font-black text-lg shadow-xl active:scale-95 transition-transform">
                        ë‹¤ìŒ íŒ ë¹„ë”©í•˜ê¸°
                    </button>
                </div>
            </section>
        </main>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    step: 1,
                    playerList: [], 
                    selectedPlayers: [],
                    players: [],
                    standbyPlayer: null, // ì´ˆê¸° ë¯¸ì„ íƒ ìƒíƒœ ìœ ì§€
                    showStandbyModal: false, // ëª¨ë‹¬ ìƒíƒœ ê´€ë¦¬
                    newPlayerName: '',
                    loading: false,
                    isAddingPlayer: false,
                    
                    gameId: '',
                    roundCount: 1,
                    
                    suits: [
                        { symbol: 'N', name: 'ë…¸ê¸°ë£¨', textColor: 'text-gray-400', borderColor: 'border-gray-400' },
                        { symbol: 'â™ ', name: 'ìŠ¤í˜ì´ë“œ', textColor: 'text-gray-900', borderColor: 'border-gray-900' },
                        { symbol: 'â™¦', name: 'ë‹¤ì´ì•„', textColor: 'text-red-600', borderColor: 'border-red-600' },
                        { symbol: 'â™£', name: 'í´ë¡œë²„', textColor: 'text-gray-900', borderColor: 'border-gray-900' },
                        { symbol: 'â™¥', name: 'í•˜íŠ¸', textColor: 'text-red-600', borderColor: 'border-red-600' }
                    ],
                    bids: [11, 12, 13, 14, 15, 16, 17, 18, 19, 20],
                    formData: { dealer: '', friend: '', suit: null, bid: null, oppScore: 0 },
                    lastResult: {}
                }
            },
            computed: {
                hasSavedSession() { return localStorage.getItem('mightySession') !== null; },
                activePlayers() { return this.players.filter(p => p.name !== this.standbyPlayer); },
                potentialFriends() {
                    const others = this.activePlayers.map(p => p.name).filter(n => n !== this.formData.dealer);
                    return [...others, 'ë…¸í”„ë Œë“œ'];
                },
                calculateMighty() { 
                    if (!this.formData.suit) return { text: '-', color: 'text-gray-300' };
                    if (this.formData.suit === 'ìŠ¤í˜ì´ë“œ') return { text: 'â™¦ A', color: 'text-red-600' };
                    return { text: 'â™  A', color: 'text-gray-900' };
                },
                calculateJokerCall() {
                    if (!this.formData.suit) return { text: '-', color: 'text-gray-300' };
                    if (this.formData.suit === 'í´ë¡œë²„') return { text: 'â™  3', color: 'text-gray-900' };
                    return { text: 'â™£ 3', color: 'text-gray-900' }; 
                }
            },
            methods: {
                togglePlayer(name) {
                    const idx = this.selectedPlayers.indexOf(name);
                    if (idx > -1) this.selectedPlayers.splice(idx, 1);
                    else if (this.selectedPlayers.length < 6) this.selectedPlayers.push(name);
                },
                async fetchPlayers() {
                    try {
                        const res = await fetch(CONFIG.GAS_URL);
                        const data = await res.json();
                        this.playerList = data.players || [];
                    } catch (e) { 
                        console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨", e); 
                    }
                },
                async addPlayer() {
                    if(!this.newPlayerName) return;
                    this.isAddingPlayer = true;
                    try {
                        await fetch(CONFIG.GAS_URL, {
                            method: "POST", mode: "no-cors",
                            headers: { "Content-Type": "text/plain" },
                            body: JSON.stringify({ action: "addPlayer", name: this.newPlayerName })
                        });
                        this.playerList.push(this.newPlayerName);
                        this.togglePlayer(this.newPlayerName);
                        this.newPlayerName = '';
                    } catch(e) {
                        alert("ë“±ë¡ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    } finally {
                        this.isAddingPlayer = false;
                    }
                },
                
                // ì£¼ê³µ ì„ íƒ í´ë¦­ ë¡œì§ (íœ´ì‹ ë©¤ë²„ëŠ” ë¶ˆê°€)
                selectDealer(name) {
                    if(this.standbyPlayer === name) return;
                    this.formData.dealer = name;
                },

                // íœ´ì‹ ì§€ì • ë¡œì§ (ëª¨ë‹¬)
                setStandby(name) {
                    this.standbyPlayer = name;
                    // ë§Œì•½ ì£¼ê³µì´ íœ´ì‹ ë©¤ë²„ë¡œ ì§€ì •ë˜ì—ˆë‹¤ë©´ ì£¼ê³µ ì´ˆê¸°í™”
                    if(this.formData.dealer === name) {
                        this.formData.dealer = '';
                    }
                    this.showStandbyModal = false;
                    this.saveSession();
                },
                
                async startGame() {
                    this.loading = true;
                    
                    // Game ID ê°•í™”: ë‚ ì§œ_ì‹œë¶„ì´ˆ_ëœë¤4ìë¦¬
                    const today = new Date();
                    const yymmdd = today.toISOString().slice(2,10).replace(/-/g, '');
                    const hhmmss = String(today.getHours()).padStart(2, '0') + String(today.getMinutes()).padStart(2, '0') + String(today.getSeconds()).padStart(2, '0');
                    const randomStr = Math.random().toString(36).substr(2, 4).toUpperCase();
                    this.gameId = `MIGHTY_${yymmdd}_${hhmmss}_${randomStr}`;
                    
                    this.roundCount = 1;
                    this.players = this.selectedPlayers.map(name => ({ name, chips: 40 }));
                    
                    // ì²˜ìŒ ë“¤ì–´ì˜¤ë©´ ë¬´ì¡°ê±´ ì „ì› í™œì„±í™” (íœ´ì‹ ì—†ìŒ)
                    this.standbyPlayer = null; 

                    try {
                        const payload = { action: "startGame", gameId: this.gameId, players: this.players };
                        await fetch(CONFIG.GAS_URL, {
                            method: "POST", mode: "no-cors",
                            headers: { "Content-Type": "text/plain" },
                            body: JSON.stringify(payload)
                        });
                    } catch (e) { console.error("ìƒˆ ê²Œì„ DB ìƒì„± ì‹¤íŒ¨"); }

                    this.saveSession();
                    this.loading = false;
                    this.step = 3;
                },
                
                saveSession() {
                    const sessionData = {
                        gameId: this.gameId, roundCount: this.roundCount,
                        players: this.players, standbyPlayer: this.standbyPlayer
                    };
                    localStorage.setItem('mightySession', JSON.stringify(sessionData));
                },
                loadSession() {
                    const data = JSON.parse(localStorage.getItem('mightySession'));
                    this.gameId = data.gameId;
                    this.roundCount = data.roundCount;
                    this.players = data.players;
                    this.standbyPlayer = data.standbyPlayer;
                    this.selectedPlayers = this.players.map(p => p.name);
                    this.step = 3;
                },

                async endGame() {
                    if(confirm("ì •ë§ ê²Œì„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì„œë²„ì— ì¢…ë£Œ ì²˜ë¦¬ë˜ë©° ì´ˆê¸°í™”ë©ë‹ˆë‹¤)")) {
                        try {
                            const payload = { action: "endGame", gameId: this.gameId };
                            await fetch(CONFIG.GAS_URL, {
                                method: "POST", mode: "no-cors",
                                headers: { "Content-Type": "text/plain" },
                                body: JSON.stringify(payload)
                            });
                        } catch (e) { console.error("DB ì¢…ë£Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"); }

                        localStorage.removeItem('mightySession');
                        this.players = [];
                        this.selectedPlayers = [];
                        this.step = 1;
                    }
                },

                async calculateResult() {
                    this.loading = true;

                    const { dealer, friend, suit, bid, oppScore } = this.formData;
                    const wonCards = 20 - oppScore;
                    const isWin = wonCards >= bid;
                    const isRun = (oppScore === 0);
                    const isBackrun = (oppScore >= 10);
                    
                    let base = 0;
                    if (bid === 20) {
                        if (isWin) base = 20;
                        else if (isBackrun) base = 20; 
                        else base = Math.ceil((bid - wonCards) * 1.5); 
                    } else {
                        if (isWin) {
                            if (isRun) base = 15;
                            else base = wonCards - 10;
                        } else {
                            if (isBackrun) base = 15;
                            else base = bid - wonCards;
                        }
                    }

                    let multiplier = 1;
                    if (suit === 'ë…¸ê¸°ë£¨') multiplier *= 2;
                    if (friend === 'ë…¸í”„ë Œë“œ') multiplier *= 2;
                    
                    const finalUnit = base * multiplier;

                    let changes = [];
                    const activeOpponents = this.activePlayers.filter(p => p.name !== dealer && p.name !== friend);
                    
                    const oppDiff = isWin ? -finalUnit : finalUnit;
                    activeOpponents.forEach(p => { changes.push({ name: p.name, role: 'ì•¼ë‹¹', diff: oppDiff }); });

                    if (friend === 'ë…¸í”„ë Œë“œ') {
                        const dealerDiff = isWin ? (finalUnit * 4) : -(finalUnit * 4);
                        changes.push({ name: dealer, role: 'ì£¼ê³µ(ë…¸í”„)', diff: dealerDiff });
                    } else {
                        const friendDiff = isWin ? finalUnit : -finalUnit;
                        const dealerDiff = isWin ? (finalUnit * 2) : -(finalUnit * 2);
                        changes.push({ name: friend, role: 'í”„ë Œë“œ', diff: friendDiff });
                        changes.push({ name: dealer, role: 'ì£¼ê³µ', diff: dealerDiff });
                    }

                    changes.forEach(c => {
                        const player = this.players.find(p => p.name === c.name);
                        player.chips += c.diff;
                        c.newTotal = player.chips; 
                    });

                    const changesLogStr = changes.map(c => `${c.name}:${c.diff > 0 ? '+' : ''}${c.diff}`).join(', ');

                    this.lastResult = { isWin, base, multiplier, finalUnit, changes };
                    
                    try {
                        const payload = {
                            action: "recordRound",
                            gameId: this.gameId,
                            round: this.roundCount,
                            dealer: dealer, friend: friend, suit: suit, bid: bid,
                            oppScore: oppScore, result: isWin ? "ìŠ¹ë¦¬" : "íŒŒì•¡",
                            changesLog: changesLogStr,
                            players: this.players
                        };
                        await fetch(CONFIG.GAS_URL, {
                            method: "POST", mode: "no-cors",
                            headers: { "Content-Type": "text/plain" },
                            body: JSON.stringify(payload)
                        });
                    } catch (e) { console.error("GAS ì €ì¥ ì‹¤íŒ¨"); }

                    this.saveSession(); 
                    this.loading = false;
                    this.step = 5;
                },

                nextRound() {
                    // ë‹¤ìŒ íŒ ì˜¤í†  ë¡œí…Œì´ì…˜ ì ìš©
                    if (this.players.length === 6 && this.standbyPlayer !== null) {
                        if (this.lastResult.isWin) {
                            if (this.formData.friend !== 'ë…¸í”„ë Œë“œ') this.standbyPlayer = this.formData.friend;
                        } else {
                            this.standbyPlayer = this.formData.dealer;
                        }
                    }

                    this.formData.dealer = ''; this.formData.friend = '';
                    this.formData.suit = null; this.formData.bid = null;
                    this.formData.oppScore = 0;
                    
                    this.roundCount++;
                    this.saveSession();
                    this.step = 3;
                }
            },
            mounted() { 
                this.fetchPlayers(); 
            }
        }).mount('#app')
    </script>
</body>
</html>