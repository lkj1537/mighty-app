<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mighty Master</title>
    <script src="config.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; overflow-y: hidden; }
        .menu-card { transition: all 0.2s; border: 1px solid #e5e7eb; }
        .menu-card:active { transform: scale(0.95); background-color: #f9fafb; }
        [v-cloak] { display: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .chip-change { animation: pop 0.3s ease-out forwards; }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-md mx-auto h-[100dvh] bg-white shadow-xl flex flex-col overflow-hidden relative">
        
        <header class="bg-gray-900 text-white py-2.5 px-4 text-center shadow-md z-10 shrink-0 flex justify-between items-center">
            <h1 class="text-base font-black italic tracking-tighter">MIGHTY MASTER</h1>
            <button v-if="step > 2" @click="endGame" class="text-[10px] text-gray-400 font-bold border border-gray-600 px-2 py-1 rounded active:bg-gray-700 transition-colors">ê¸°ë¡ ì´ˆê¸°í™”</button>
        </header>

        <main class="flex-grow p-3 flex flex-col overflow-y-auto">
            
            <section v-if="step === 1" class="flex-grow flex flex-col justify-center space-y-4">
                <div class="text-center mb-6">
                    <p class="text-gray-400 text-xs font-bold uppercase tracking-widest">Welcome</p>
                    <h2 class="text-2xl font-black text-gray-800">ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</h2>
                </div>
                
                <button v-if="hasSavedSession" @click="loadSession" class="menu-card w-full p-5 rounded-2xl bg-blue-50 border-blue-200 shadow-sm flex items-center justify-between">
                    <div class="text-left">
                        <h3 class="text-lg font-black text-blue-800">ì´ì „ ê²Œì„ ì´ì–´ì„œ í•˜ê¸°</h3>
                        <p class="text-xs text-blue-500">ì €ì¥ëœ ì„¸ì…˜ì´ ìˆìŠµë‹ˆë‹¤</p>
                    </div>
                    <span class="text-2xl">ğŸ”„</span>
                </button>

                <button @click="step = 2" class="menu-card w-full p-6 rounded-2xl bg-white shadow-sm flex items-center justify-between">
                    <div class="text-left">
                        <h3 class="text-lg font-black text-gray-800">ìƒˆ ê²Œì„ ì‹œì‘</h3>
                        <p class="text-xs text-gray-400">ì¸ì›(5~6ëª…) ì„ íƒ ë° ë¹„ë”©</p>
                    </div>
                    <span class="text-3xl">ğŸƒ</span>
                </button>
            </section>

            <section v-if="step === 2" class="flex flex-col h-full space-y-4">
                <div class="flex justify-between items-center pb-2 border-b">
                    <h2 class="text-xl font-black text-gray-800">ì¸ì› ì„ íƒ (5~6ëª…)</h2>
                    <span :class="['font-black text-sm', selectedPlayers.length >= 5 && selectedPlayers.length <= 6 ? 'text-blue-600' : 'text-red-500']">{{ selectedPlayers.length }} ëª…</span>
                </div>
                
                <div v-if="playerList.length === 0" class="text-center text-gray-400 text-sm py-4">
                    ë¶ˆëŸ¬ì˜¬ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ì—ì„œ ë©¤ë²„ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.
                </div>

                <div class="grid grid-cols-2 gap-2 max-h-[40vh] overflow-y-auto p-1">
                    <button v-for="name in playerList" :key="name" @click="togglePlayer(name)"
                        :class="['p-3 rounded-xl border-2 text-sm font-bold transition-all flex items-center justify-center gap-2', selectedPlayers.includes(name) ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-gray-100 bg-white text-gray-400']">
                        <span v-if="selectedPlayers.includes(name)" class="text-xs bg-blue-600 text-white rounded-md px-1.5 py-0.5 font-black">{{ selectedPlayers.indexOf(name) + 1 }}</span>
                        {{ name }}
                    </button>
                </div>

                <div class="bg-gray-100 p-2 rounded-xl flex gap-2 shrink-0">
                    <input v-model="newPlayerName" @keyup.enter="addPlayer" class="flex-grow bg-transparent px-3 text-sm outline-none" placeholder="ì‹ ê·œ ë©¤ë²„ ì¶”ê°€...">
                    <button @click="addPlayer" :disabled="isAddingPlayer" class="bg-white px-3 py-2 rounded-lg text-xs font-black shadow-sm disabled:opacity-50">ë“±ë¡</button>
                </div>

                <div class="mt-auto pt-2 shrink-0 space-y-2">
                    <button @click="startGame" :disabled="selectedPlayers.length < 5 || selectedPlayers.length > 6 || loading"
                        class="w-full py-3.5 bg-blue-600 text-white rounded-2xl font-black text-base shadow-lg disabled:bg-gray-200 transition-colors">
                        {{ loading ? 'ì‹œì‘ ì¤‘...' : (selectedPlayers.length === 6 ? '6ë§ˆ ì‹œì‘' : '5ë§ˆ ì‹œì‘') }}
                    </button>
                    <button @click="step = 1" class="w-full py-2 text-gray-400 font-bold text-sm">ì·¨ì†Œ</button>
                </div>
            </section>

            <section v-if="step === 3" class="flex flex-col h-full space-y-2 relative">
                <div class="flex justify-between items-center px-1">
                    <h2 class="text-base font-black text-gray-800">Round {{ roundCount }} ë¹„ë”©</h2>
                </div>

                <div class="space-y-1.5 shrink-0 bg-blue-50 p-2.5 rounded-xl border border-blue-100">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[11px] font-black text-blue-600 uppercase tracking-widest ml-1">ì£¼ê³µ ì„ íƒ</label>
                        <button v-if="players.length === 6" @click="showStandbyModal = true" class="text-[10px] bg-white border border-gray-300 text-gray-700 px-2 py-1 rounded shadow-sm font-bold active:bg-gray-100 transition-colors">
                            íœ´ì‹ ì§€ì • âš™ï¸
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-1.5">
                        <button v-for="p in players" :key="p.name" @click="selectDealer(p.name)"
                            :disabled="standbyPlayer === p.name"
                            :class="[
                                'p-2 rounded-lg border-2 flex flex-col items-center justify-center transition-all relative',
                                standbyPlayer === p.name ? 'border-gray-200 bg-gray-100 opacity-60 cursor-not-allowed' :
                                formData.dealer === p.name ? 'border-blue-600 bg-white text-blue-700 shadow-md ring-1 ring-blue-100' : 'border-gray-200 bg-white text-gray-700 shadow-sm hover:border-blue-300 cursor-pointer'
                            ]">
                            <span v-if="standbyPlayer === p.name" class="absolute top-1 left-1 bg-red-500 text-white text-[9px] font-black px-1 rounded shadow-sm">íœ´ì‹</span>
                            
                            <span class="text-xs font-black">{{ p.name }}</span>
                            <span :class="['text-sm font-black mt-0.5', p.chips < 0 ? 'text-red-500' : 'text-gray-900']">{{ p.chips }}</span>
                        </button>
                    </div>
                </div>

                <div class="space-y-1 flex-grow flex flex-col overflow-hidden min-h-[180px]">
                    <div class="bg-gray-50 py-1.5 pr-2 pl-0 rounded-xl border border-gray-200 overflow-x-auto hide-scrollbar flex-grow relative">
                        <div class="min-w-max flex flex-col gap-1.5 py-0.5">
                            <div v-for="s in suits" :key="s.name" class="flex items-center">
                                <div :class="['sticky left-0 bg-gray-50 w-10 h-8 flex items-center justify-center font-black text-[20px] shrink-0 z-30 shadow-[4px_0_8px_-6px_rgba(0,0,0,0.2)]', s.textColor]">
                                    {{ s.symbol }}
                                </div>
                                <div class="flex gap-2 ml-1 pr-8 relative z-0">
                                    <button v-for="num in bids" :key="num"
                                        @click="formData.suit = s.name; formData.bid = num"
                                        :class="[
                                            'w-8 h-8 rounded-full border-2 font-black text-xs transition-all flex shrink-0 items-center justify-center', 
                                            formData.suit === s.name && formData.bid === num 
                                                ? 'bg-gray-800 text-white border-gray-800 scale-110 shadow-md z-20' 
                                                : 'bg-white border-gray-300 ' + s.textColor,
                                            (s.name === 'ë…¸ê¸°ë£¨' || num === 20) ? 'translate-x-[20px]' : ''
                                        ]">
                                        {{ num }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-2.5 bg-white border border-gray-200 rounded-xl shadow-sm shrink-0">
                    <div class="flex justify-between items-center mb-1 pb-1 border-b border-gray-100">
                        <span class="text-xs font-black text-gray-500">í˜„ì¬ ë¹„ë”©</span>
                        <span v-if="formData.suit && formData.bid" class="text-base font-black text-blue-600">
                            {{ formData.suit }} {{ formData.bid }}
                        </span>
                        <span v-else class="text-xs text-gray-400">ì„ íƒ ëŒ€ê¸°</span>
                    </div>
                    <div class="flex justify-between items-center px-1 pt-0.5">
                        <p class="text-[10px] font-black text-gray-500">ë§ˆì´í‹° <span :class="['text-[11px] ml-1 font-black', calculateMighty.color]">{{ calculateMighty.text }}</span></p>
                        <p class="text-[10px] font-black text-gray-500">ì¡°ì»¤ ì½œ <span :class="['text-[11px] ml-1 font-black', calculateJokerCall.color]">{{ calculateJokerCall.text }}</span></p>
                    </div>
                </div>

                <div class="shrink-0 pt-0.5 pb-1">
                    <button @click="step = 4" :disabled="!formData.dealer || !formData.suit || !formData.bid || (players.length === 6 && !standbyPlayer)"
                        class="w-full py-3.5 bg-blue-600 text-white rounded-2xl font-black text-sm shadow-lg disabled:bg-gray-200 disabled:text-gray-400 transition-colors">
                        ë¼ìš´ë“œ ì‹œì‘
                    </button>
                </div>
                
                <div v-if="showStandbyModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-5">
                    <div class="bg-white rounded-[2rem] w-full max-w-sm p-6 space-y-5 shadow-2xl">
                        <h3 class="text-lg font-black text-gray-800 text-center">íœ´ì‹ ë©¤ë²„ ì§€ì •</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button v-for="p in players" :key="p.name" @click="setStandby(p.name)"
                                :class="['p-3 border-2 rounded-xl font-black text-sm transition-all', standbyPlayer === p.name ? 'border-blue-600 bg-blue-50 text-blue-600 shadow-inner' : 'border-gray-200 text-gray-700 bg-white']">
                                {{ p.name }}
                            </button>
                            <button @click="setStandby(null)"
                                :class="['col-span-2 p-3 border-2 rounded-xl font-black text-sm transition-all', standbyPlayer === null ? 'border-blue-600 bg-blue-50 text-blue-600 shadow-inner' : 'border-gray-200 text-gray-500 bg-gray-50']">
                                ë¯¸ì„ íƒ (ì „ì› ì°¸ì—¬)
                            </button>
                        </div>
                        <button @click="showStandbyModal = false" class="w-full py-3.5 bg-gray-900 text-white font-black text-sm rounded-xl active:scale-95 transition-transform">ë‹«ê¸°</button>
                    </div>
                </div>
            </section>

            <section v-if="step === 4" class="flex flex-col h-full space-y-3">
                
                <div class="bg-gray-900 px-4 py-4 rounded-3xl shadow-xl relative text-center shrink-0">
                    <div class="flex flex-col items-center justify-center space-y-1 mb-3">
                        <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest border border-gray-600 px-2 py-0.5 rounded-full mb-1">ì¸ê²Œì„ ì •ë³´</span>
                        
                        <div class="text-white text-2xl font-black tracking-tight">
                            [ <span class="text-blue-400">{{ formData.dealer }}</span> 
                            <span :class="['mx-1', currentSuit.color]">{{ currentSuit.symbol }}</span> 
                            {{ formData.bid }} ]
                        </div>
                        <p class="text-xs text-gray-400 mt-1">ì•¼ë‹¹ ëª©í‘œ: <span class="text-red-400 font-bold">{{ 21 - formData.bid }}ì¥</span> ì´ìƒ</p>
                    </div>

                    <div class="grid grid-cols-2 gap-3 relative z-10">
                        <div class="bg-white py-2 rounded-xl shadow-inner flex flex-col items-center justify-center">
                            <p class="text-[10px] text-gray-400 font-black mb-0.5">ë§ˆì´í‹°</p>
                            <p :class="['text-xl font-black', calculateMighty.color]">{{ calculateMighty.text }}</p>
                        </div>
                        <div class="bg-white py-2 rounded-xl shadow-inner flex flex-col items-center justify-center">
                            <p class="text-[10px] text-gray-400 font-black mb-0.5">ì¡°ì»¤ ì½œ</p>
                            <p :class="['text-xl font-black', calculateJokerCall.color]">{{ calculateJokerCall.text }}</p>
                        </div>
                    </div>
                </div>

                <div class="flex-grow space-y-3">
                    <div class="bg-gray-50 p-2.5 rounded-2xl border border-gray-200">
                        <label class="block text-[11px] font-black text-gray-500 mb-2 ml-1">í”„ë Œë“œ</label>
                        <div class="grid grid-cols-5 gap-1.5">
                            <button v-for="p in potentialFriendsList" :key="p.name" @click="formData.friend = p.name"
                                :class="['py-2 rounded-lg border-2 flex flex-col items-center justify-center transition-all relative', 
                                        formData.friend === p.name ? 'border-blue-600 bg-blue-50 shadow-sm' : 'border-gray-200 bg-white']">
                                <span class="text-xs font-bold text-gray-700">{{ p.name }}</span>
                                <span :class="['text-[10px] font-black mt-0.5', p.chips < 0 ? 'text-red-500' : 'text-gray-500']">{{ p.chips }}</span>
                            </button>
                            
                            <button @click="formData.friend = 'ë…¸í”„ë Œë“œ'"
                                :class="['py-2 rounded-lg border-2 flex flex-col items-center justify-center transition-all', 
                                        formData.friend === 'ë…¸í”„ë Œë“œ' ? 'border-red-500 bg-red-50' : 'border-gray-300 bg-gray-100']">
                                <span :class="['text-[11px] font-black', formData.friend === 'ë…¸í”„ë Œë“œ' ? 'text-red-600' : 'text-gray-600']">ë…¸í”„ë Œë“œ</span>
                                <span class="text-[9px] text-gray-400 mt-0.5">ë…ì‹/ë…ë°•</span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-gray-50 px-4 py-3 rounded-2xl border border-gray-200 flex flex-col items-center">
                        <div class="flex justify-between w-full items-center mb-2">
                            <label class="block text-[11px] font-black text-gray-500">ì•¼ë‹¹ íšë“ ì¥ìˆ˜</label>
                            <span v-if="formData.bid" :class="['text-[11px] font-black px-2 py-1 rounded text-white shadow-sm', isCurrentBidSuccess ? 'bg-green-500' : 'bg-red-500']">
                                {{ isCurrentBidSuccess ? 'ğŸŸ¢ ì—¬ë‹¹ ìŠ¹ë¦¬ (ì„±ê³µ)' : 'ğŸ”´ ì•¼ë‹¹ ìŠ¹ë¦¬ (ì‹¤íŒ¨)' }}
                            </span>
                        </div>
                        
                        <div class="flex items-center justify-center gap-6 w-full mb-3">
                            <button @click="formData.oppScore = Math.max(0, formData.oppScore - 1)" 
                                    class="w-12 h-12 rounded-full bg-white shadow-sm border border-gray-200 text-2xl font-black text-gray-600 active:scale-95 flex items-center justify-center pb-1">-</button>
                            <span class="text-5xl font-black w-16 text-center text-gray-800">{{ formData.oppScore }}</span>
                            <button @click="formData.oppScore = Math.min(20, formData.oppScore + 1)" 
                                    class="w-12 h-12 rounded-full bg-white shadow-sm border border-gray-200 text-2xl font-black text-gray-600 active:scale-95 flex items-center justify-center pb-1">+</button>
                        </div>
                        <input type="range" v-model.number="formData.oppScore" min="0" max="20" class="w-full accent-blue-600 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>

                <div class="flex gap-2 mt-auto shrink-0 pt-1 pb-1">
                    <button @click="step = 3" class="flex-1 py-3.5 bg-gray-100 border border-gray-300 text-gray-600 rounded-2xl font-bold text-sm">ë¹„ë”©ìœ¼ë¡œ ê°€ê¸°</button>
                    <button @click="calculateResult" :disabled="!formData.friend || loading" class="flex-[2] py-3.5 bg-gray-900 text-white rounded-2xl font-black text-base active:scale-95 transition-transform disabled:bg-gray-300 relative overflow-hidden">
                        <span v-if="loading" class="animate-pulse">ì²˜ë¦¬ ì¤‘...</span>
                        <span v-else>ì •ì‚°</span>
                    </button>
                </div>
            </section>

            <section v-if="step === 5" class="flex flex-col h-full space-y-3">
                <div :class="['py-4 rounded-3xl text-center transition-all border-4 shrink-0 shadow-sm relative overflow-hidden', 
                              lastResult.isWin ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200']">
                    
                    <button @click="revertResult" class="absolute top-3 left-3 text-[10px] font-bold text-gray-500 bg-white/80 px-2 py-1 rounded border border-gray-200 active:bg-gray-100">
                        â¬…ï¸ ê²°ê³¼ ì·¨ì†Œ
                    </button>

                    <h2 :class="['text-2xl font-black mb-1 mt-6', lastResult.isWin ? 'text-green-600' : 'text-red-600']">
                        {{ lastResult.isWin ? 'ì—¬ë‹¹ ìŠ¹ë¦¬ ğŸ‰' : 'ì•¼ë‹¹ ìŠ¹ë¦¬ ğŸ’€' }}
                    </h2>
                    <p class="text-[11px] font-bold text-gray-500">{{ formData.suit }} {{ formData.bid }} (ì•¼ë‹¹ {{ formData.oppScore }}ì¥)</p>
                    <div class="mt-2 inline-block bg-white px-3 py-1.5 rounded-full shadow-sm border border-gray-100">
                        <span class="text-[10px] font-bold text-gray-400 mr-2">ìœ ë‹› x ë°°ìˆ˜</span>
                        <span class="text-sm font-black text-gray-800">{{ lastResult.base }} Ã— {{ lastResult.multiplier }} = <span class="text-blue-600">{{ lastResult.finalUnit }}ê°œ</span></span>
                    </div>
                </div>

                <div class="flex-grow bg-white rounded-2xl shadow-sm border border-gray-100 p-2 space-y-1.5 overflow-hidden flex flex-col justify-center">
                    <div v-for="change in lastResult.changes" :key="change.name" 
                         class="flex justify-between items-center px-3 py-2 rounded-xl bg-gray-50 chip-change border border-gray-100">
                        
                        <div class="flex items-center gap-3">
                            <div class="flex flex-col items-start">
                                <div class="flex items-center gap-1.5">
                                    <span class="font-black text-gray-800 text-sm">{{ change.name }}</span>
                                    <span v-if="change.role" class="text-[9px] font-bold text-white px-1.5 py-0.5 rounded" 
                                          :class="change.role.includes('ì£¼ê³µ') ? 'bg-blue-600' : (change.role === 'í”„ë Œë“œ' ? 'bg-blue-400' : 'bg-gray-400')">
                                        {{ change.role }}
                                    </span>
                                </div>
                                <span :class="['font-black text-base mt-0.5', change.diff > 0 ? 'text-green-500' : 'text-red-500']">
                                    {{ change.diff > 0 ? '+' : '' }}{{ change.diff }}
                                </span>
                            </div>
                        </div>

                        <div class="text-right flex flex-col items-end justify-center">
                            <p class="text-[9px] text-gray-400 font-bold mb-0.5">ì´ ì¹© ê°¯ìˆ˜</p>
                            <p class="font-black text-2xl text-gray-800 tracking-tight">{{ change.newTotal }}</p>
                        </div>
                    </div>
                </div>

                <div class="mt-auto shrink-0 pt-1 pb-1">
                    <button @click="nextRound" class="w-full py-4 bg-gray-900 text-white rounded-[1.5rem] font-black text-base shadow-xl active:scale-95 transition-transform">
                        ë‹¤ìŒ íŒ ë¹„ë”©í•˜ê¸°
                    </button>
                </div>
            </section>
        </main>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    step: 1,
                    playerList: [], 
                    selectedPlayers: [],
                    players: [],
                    standbyPlayer: null, 
                    showStandbyModal: false, 
                    newPlayerName: '',
                    loading: false,
                    isAddingPlayer: false,
                    
                    gameId: '',
                    roundCount: 1,
                    
                    suits: [
                        { symbol: 'N', name: 'ë…¸ê¸°ë£¨', textColor: 'text-gray-400', borderColor: 'border-gray-400' },
                        { symbol: 'â™ ', name: 'ìŠ¤í˜ì´ë“œ', textColor: 'text-gray-900', borderColor: 'border-gray-900' },
                        { symbol: 'â™¦', name: 'ë‹¤ì´ì•„', textColor: 'text-red-600', borderColor: 'border-red-600' },
                        { symbol: 'â™£', name: 'í´ë¡œë²„', textColor: 'text-gray-900', borderColor: 'border-gray-900' },
                        { symbol: 'â™¥', name: 'í•˜íŠ¸', textColor: 'text-red-600', borderColor: 'border-red-600' }
                    ],
                    bids: [11, 12, 13, 14, 15, 16, 17, 18, 19, 20],
                    formData: { dealer: '', friend: '', suit: null, bid: null, oppScore: 0 },
                    lastResult: {}
                }
            },
            computed: {
                hasSavedSession() { return localStorage.getItem('mightySession') !== null; },
                activePlayers() { return this.players.filter(p => p.name !== this.standbyPlayer); },
                
                // 5ë²ˆ ë°˜ì˜: í”„ë Œë“œ ì„ íƒì°½ ìš© (í™œì„± í”Œë ˆì´ì–´ ì¤‘ ì£¼ê³µ ì œì™¸ ë°°ì—´ ë°˜í™˜)
                potentialFriendsList() {
                    return this.activePlayers.filter(p => p.name !== this.formData.dealer);
                },

                // 3ë²ˆ ë°˜ì˜: ì¸ê²Œì„ ìƒë‹¨ ì§ê´€ì  ë¬¸ì–‘ ë§¤ì¹­ ìš©
                currentSuit() {
                    if (!this.formData.suit) return { symbol: '', color: '' };
                    const found = this.suits.find(s => s.name === this.formData.suit);
                    return found ? { symbol: found.symbol, color: found.textColor } : { symbol: '', color: '' };
                },

                isCurrentBidSuccess() {
                    if(!this.formData.bid) return false;
                    const wonCards = 20 - this.formData.oppScore;
                    return wonCards >= this.formData.bid;
                },

                calculateMighty() { 
                    if (!this.formData.suit) return { text: '-', color: 'text-gray-300' };
                    if (this.formData.suit === 'ìŠ¤í˜ì´ë“œ') return { text: 'â™¦ A', color: 'text-red-600' };
                    return { text: 'â™  A', color: 'text-gray-900' };
                },
                calculateJokerCall() {
                    if (!this.formData.suit) return { text: '-', color: 'text-gray-300' };
                    if (this.formData.suit === 'í´ë¡œë²„') return { text: 'â™  3', color: 'text-gray-900' };
                    return { text: 'â™£ 3', color: 'text-gray-900' }; 
                }
            },
            methods: {
                togglePlayer(name) {
                    const idx = this.selectedPlayers.indexOf(name);
                    if (idx > -1) this.selectedPlayers.splice(idx, 1);
                    else if (this.selectedPlayers.length < 6) this.selectedPlayers.push(name);
                },
                async fetchPlayers() {
                    try {
                        const res = await fetch(CONFIG.GAS_URL);
                        const data = await res.json();
                        this.playerList = data.players || [];
                    } catch (e) { console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨", e); }
                },
                async addPlayer() {
                    if(!this.newPlayerName) return;
                    this.isAddingPlayer = true;
                    this.playerList.push(this.newPlayerName);
                    this.togglePlayer(this.newPlayerName);
                    
                    fetch(CONFIG.GAS_URL, {
                        method: "POST", mode: "no-cors",
                        headers: { "Content-Type": "text/plain" },
                        body: JSON.stringify({ action: "addPlayer", name: this.newPlayerName })
                    }).catch(()=>console.log("DBë“±ë¡ ì§€ì—°ë¨"));
                    
                    this.newPlayerName = '';
                    this.isAddingPlayer = false;
                },
                
                selectDealer(name) {
                    if(this.standbyPlayer === name) return;
                    this.formData.dealer = name;
                },

                setStandby(name) {
                    this.standbyPlayer = name;
                    if(this.formData.dealer === name) this.formData.dealer = '';
                    this.showStandbyModal = false;
                    this.saveSession();
                },
                
                async startGame() {
                    this.loading = true;
                    
                    // 8ë²ˆ ë°˜ì˜: ì‹¬í”Œí•˜ê³  ê¹”ë”í•œ Game ID 
                    const today = new Date().toISOString().slice(2,10).replace(/-/g, '');
                    const randomStr = Math.random().toString(36).substr(2, 4).toUpperCase();
                    this.gameId = `MIGHTY_${today}_${randomStr}`;
                    
                    this.roundCount = 1;
                    this.players = this.selectedPlayers.map(name => ({ name, chips: 40 }));
                    this.standbyPlayer = null; 

                    const payload = { action: "startGame", gameId: this.gameId, players: this.players };
                    fetch(CONFIG.GAS_URL, {
                        method: "POST", mode: "no-cors",
                        headers: { "Content-Type": "text/plain" },
                        body: JSON.stringify(payload)
                    }).catch(e => console.error(e));

                    this.saveSession();
                    this.loading = false;
                    this.step = 3;
                },
                
                saveSession() {
                    const sessionData = {
                        gameId: this.gameId, roundCount: this.roundCount,
                        players: this.players, standbyPlayer: this.standbyPlayer
                    };
                    localStorage.setItem('mightySession', JSON.stringify(sessionData));
                },
                loadSession() {
                    const data = JSON.parse(localStorage.getItem('mightySession'));
                    this.gameId = data.gameId;
                    this.roundCount = data.roundCount;
                    this.players = data.players;
                    this.standbyPlayer = data.standbyPlayer;
                    this.selectedPlayers = this.players.map(p => p.name);
                    this.step = 3;
                },

                async endGame() {
                    if(confirm("ê¸°ë¡ì„ ì™„ì „íˆ ì´ˆê¸°í™”í•˜ê³  ì²˜ìŒìœ¼ë¡œ ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        localStorage.removeItem('mightySession');
                        this.players = [];
                        this.selectedPlayers = [];
                        this.step = 1;
                    }
                },

                async calculateResult() {
                    this.loading = true;

                    const { dealer, friend, suit, bid, oppScore } = this.formData;
                    const wonCards = 20 - oppScore;
                    const isWin = wonCards >= bid;
                    const isRun = (oppScore === 0);
                    const isBackrun = (oppScore >= 10);
                    
                    let base = 0;
                    if (bid === 20) {
                        if (isWin) base = 20;
                        else if (isBackrun) base = 20; 
                        else base = Math.ceil((bid - wonCards) * 1.5); 
                    } else {
                        if (isWin) {
                            if (isRun) base = 15;
                            else base = wonCards - 10;
                        } else {
                            if (isBackrun) base = 15;
                            else base = bid - wonCards;
                        }
                    }

                    let multiplier = 1;
                    if (suit === 'ë…¸ê¸°ë£¨') multiplier *= 2;
                    if (friend === 'ë…¸í”„ë Œë“œ') multiplier *= 2;
                    
                    const finalUnit = base * multiplier;

                    let changes = [];
                    const activeOpponents = this.activePlayers.filter(p => p.name !== dealer && p.name !== friend);
                    
                    const oppDiff = isWin ? -finalUnit : finalUnit;
                    activeOpponents.forEach(p => { changes.push({ name: p.name, role: 'ì•¼ë‹¹', diff: oppDiff }); });

                    if (friend === 'ë…¸í”„ë Œë“œ') {
                        const dealerDiff = isWin ? (finalUnit * 4) : -(finalUnit * 4);
                        changes.push({ name: dealer, role: 'ì£¼ê³µ(ë…¸í”„)', diff: dealerDiff });
                    } else {
                        const friendDiff = isWin ? finalUnit : -finalUnit;
                        const dealerDiff = isWin ? (finalUnit * 2) : -(finalUnit * 2);
                        changes.push({ name: friend, role: 'í”„ë Œë“œ', diff: friendDiff });
                        changes.push({ name: dealer, role: 'ì£¼ê³µ', diff: dealerDiff });
                    }

                    changes.forEach(c => {
                        const player = this.players.find(p => p.name === c.name);
                        player.chips += c.diff;
                        c.newTotal = player.chips; 
                    });

                    const changesLogStr = changes.map(c => `${c.name}:${c.diff > 0 ? '+' : ''}${c.diff}`).join(', ');
                    this.lastResult = { isWin, base, multiplier, finalUnit, changes };
                    
                    // ë°±ê·¸ë¼ìš´ë“œ ì„œë²„ ì „ì†¡
                    const payload = {
                        action: "recordRound", gameId: this.gameId, round: this.roundCount,
                        dealer: dealer, friend: friend, suit: suit, bid: bid,
                        oppScore: oppScore, result: isWin ? "ìŠ¹ë¦¬" : "íŒŒì•¡",
                        changesLog: changesLogStr, players: this.players
                    };
                    fetch(CONFIG.GAS_URL, {
                        method: "POST", mode: "no-cors",
                        headers: { "Content-Type": "text/plain" },
                        body: JSON.stringify(payload)
                    });

                    this.saveSession(); 
                    this.loading = false;
                    this.step = 5;
                },

                revertResult() {
                    if(!confirm("ë°©ê¸ˆ ì •ì‚°í•œ ì¹©ì„ ì›ë˜ëŒ€ë¡œ ëŒë¦¬ê³  ì´ì „ í™”ë©´ìœ¼ë¡œ ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                    this.lastResult.changes.forEach(c => {
                        const player = this.players.find(p => p.name === c.name);
                        if(player) player.chips -= c.diff; 
                    });
                    this.saveSession();
                    this.step = 4; 
                },

                nextRound() {
                    // 11ë²ˆ ì˜¤í† ë¡œí…Œì´ì…˜ ì¬í™•ì¸ ì ìš©
                    if (this.players.length === 6) {
                        if (this.lastResult.isWin) {
                            if (this.formData.friend !== 'ë…¸í”„ë Œë“œ') this.standbyPlayer = this.formData.friend;
                        } else {
                            this.standbyPlayer = this.formData.dealer;
                        }
                    }

                    this.formData.dealer = ''; this.formData.friend = '';
                    this.formData.suit = null; this.formData.bid = null;
                    this.formData.oppScore = 0;
                    
                    this.roundCount++;
                    this.saveSession();
                    this.step = 3;
                }
            },
            mounted() { 
                this.fetchPlayers(); 
            }
        }).mount('#app')
    </script>
</body>
</html>