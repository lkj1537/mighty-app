<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mighty Master</title>
    <script src="config.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; overflow-y: hidden; }
        .menu-card { transition: all 0.2s; border: 1px solid #e5e7eb; }
        .menu-card:active { transform: scale(0.95); background-color: #f9fafb; }
        [v-cloak] { display: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .chip-change { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes pop { 0% { transform: translateY(10px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-md mx-auto h-[100dvh] bg-white shadow-xl flex flex-col overflow-hidden relative">
        
        <header class="bg-gray-900 text-white py-3 px-4 text-center shadow-md z-10 shrink-0 flex justify-between items-center">
            <h1 class="text-sm font-black italic tracking-tighter">MIGHTY MASTER</h1>
            <button v-if="step > 2" @click="endGame" class="text-[10px] text-gray-400 font-bold border border-gray-600 px-2 py-1 rounded active:bg-gray-700">ê¸°ë¡ ì´ˆê¸°í™”</button>
        </header>

        <main class="flex-grow p-3 flex flex-col overflow-y-auto">
            
            <section v-if="step === 1" class="flex-grow flex flex-col justify-center space-y-4">
                <div class="text-center mb-6">
                    <p class="text-gray-400 text-xs font-bold uppercase tracking-widest">Welcome</p>
                    <h2 class="text-2xl font-black text-gray-800">ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</h2>
                </div>
                <button v-if="hasSavedSession" @click="loadSession" class="menu-card w-full p-5 rounded-2xl bg-blue-50 border-blue-200 shadow-sm flex items-center justify-between">
                    <div class="text-left"><h3 class="text-lg font-black text-blue-800">ì´ì „ ê²Œì„ ì´ì–´í•˜ê¸°</h3></div>
                    <span class="text-2xl">ğŸ”„</span>
                </button>
                <button @click="step = 2" class="menu-card w-full p-6 rounded-2xl bg-white shadow-sm flex items-center justify-between group">
                    <div class="text-left"><h3 class="text-lg font-black text-gray-800">ìƒˆ ê²Œì„ ì‹œì‘</h3></div>
                    <span class="text-3xl">ğŸƒ</span>
                </button>
            </section>

            <section v-if="step === 2" class="flex flex-col h-full space-y-4">
                <div class="flex justify-between items-center pb-1 border-b mt-2">
                    <h2 class="text-xl font-black text-gray-800">ì¸ì› ì„ íƒ (5~6ëª…)</h2>
                    <span :class="['font-black text-sm', selectedPlayers.length >= 5 && selectedPlayers.length <= 6 ? 'text-blue-600' : 'text-red-500']">{{ selectedPlayers.length }} ëª…</span>
                </div>
                <div class="grid grid-cols-2 gap-2 flex-grow overflow-y-auto p-1">
                    <button v-for="name in playerList" :key="name" @click="togglePlayer(name)"
                        :class="['p-4 rounded-xl border-2 text-sm font-bold transition-all flex items-center justify-center gap-2', selectedPlayers.includes(name) ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-gray-100 bg-white text-gray-400']">
                        <span v-if="selectedPlayers.includes(name)" class="text-xs bg-blue-600 text-white rounded-md px-1.5 py-0.5 font-black">{{ selectedPlayers.indexOf(name) + 1 }}</span>
                        {{ name }}
                    </button>
                </div>
                <div class="bg-gray-100 p-2 rounded-xl flex gap-2 shrink-0">
                    <input v-model="newPlayerName" @keyup.enter="addPlayer" class="flex-grow bg-transparent px-3 text-sm outline-none" placeholder="ì‹ ê·œ ë©¤ë²„ ì¶”ê°€...">
                    <button @click="addPlayer" class="bg-white px-3 py-2 rounded-lg text-xs font-black shadow-sm">ë“±ë¡</button>
                </div>
                <button @click="startGame" :disabled="selectedPlayers.length < 5 || selectedPlayers.length > 6 || loading"
                    class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black text-base shadow-lg disabled:bg-gray-200">
                    {{ loading ? 'ì‹œì‘ ì¤‘...' : (selectedPlayers.length === 6 ? '6ë§ˆ ì‹œì‘' : '5ë§ˆ ì‹œì‘') }}
                </button>
            </section>

            <section v-if="step === 3" class="flex flex-col h-full space-y-2 relative">
                <div class="flex justify-between items-center px-1 shrink-0 mt-1">
                    <h2 class="text-sm font-black text-gray-800">Round {{ roundCount }} ë¹„ë”©</h2>
                </div>

                <div class="space-y-1.5 shrink-0 bg-blue-50 p-2.5 rounded-xl border border-blue-100">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[11px] font-black text-blue-600 uppercase ml-1">ì£¼ê³µ ì„ íƒ</label>
                        <button v-if="players.length === 6" @click="showStandbyModal = true" class="text-[10px] bg-white border px-2 py-1 rounded font-bold shadow-sm">íœ´ì‹ ì§€ì • âš™ï¸</button>
                    </div>
                    <div class="grid grid-cols-3 gap-1.5">
                        <button v-for="p in players" :key="p.name" @click="selectDealer(p.name)"
                            :disabled="standbyPlayer === p.name"
                            :class="['p-2 rounded-lg border-2 flex flex-col items-center justify-center transition-all relative',
                                standbyPlayer === p.name ? 'border-gray-200 bg-gray-100 opacity-30' :
                                formData.dealer === p.name ? 'border-blue-600 bg-white text-blue-700 shadow-md ring-1 ring-blue-100' : 'border-gray-200 bg-white text-gray-700 shadow-sm']">
                            <span v-if="standbyPlayer === p.name" class="absolute top-1 left-1 bg-red-500 text-white text-[8px] font-black px-1 rounded">íœ´ì‹</span>
                            <span class="text-xs font-black">{{ p.name }}</span>
                            <span class="text-[10px] font-bold opacity-50 mt-0.5">{{ p.chips }}</span>
                        </button>
                    </div>
                </div>

                <div class="flex-grow bg-gray-50 rounded-2xl border p-2 flex flex-col overflow-hidden">
                    <div class="flex-grow overflow-y-auto pr-1">
                        <div v-for="s in suits" :key="s.name" class="flex items-center mb-2">
                            <div :class="['w-10 text-2xl font-black text-center', s.textColor]">{{ s.symbol }}</div>
                            <div class="flex gap-2 overflow-x-auto hide-scrollbar py-1">
                                <button v-for="num in bids" :key="num" @click="formData.suit = s.name; formData.bid = num"
                                    :class="['w-9 h-9 rounded-full border-2 font-black text-sm transition-all flex shrink-0 items-center justify-center shadow-sm', 
                                    formData.suit === s.name && formData.bid === num ? 'bg-gray-800 text-white border-gray-800 scale-110' : 'bg-white border-gray-200 ' + s.textColor]">{{ num }}</button>
                                <div class="w-4 shrink-0"></div> </div>
                        </div>
                    </div>
                </div>

                <div class="shrink-0 pt-1 pb-1">
                    <button @click="step = 4" :disabled="!isBiddingComplete" 
                        :class="['w-full py-4 rounded-2xl font-black text-sm shadow-lg transition-all', isBiddingComplete ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-400']">
                        {{ roundStartButtonText }}
                    </button>
                </div>
            </section>

            <section v-if="step === 4" class="flex flex-col h-full space-y-3">
                
                <div class="grid grid-cols-2 gap-2 shrink-0">
                    <div class="bg-white border border-gray-200 rounded-2xl p-3 flex flex-col items-center justify-center shadow-sm">
                        <span :class="['text-3xl font-black', calculateMighty.color]">{{ calculateMighty.text }}</span>
                        <span class="text-[10px] font-black text-gray-400 mt-1 uppercase">ë§ˆì´í‹°</span>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-2xl p-3 flex flex-col items-center justify-center shadow-sm">
                        <span class="text-3xl font-black text-gray-800">{{ calculateJokerCall.text }}</span>
                        <span class="text-[10px] font-black text-gray-400 mt-1 uppercase">ì¡°ì»¤ì½œ</span>
                    </div>
                </div>

                <div class="bg-blue-50 p-3 rounded-2xl border border-blue-100 shrink-0">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[11px] font-black text-blue-600 uppercase ml-1">í”„ë Œë“œ ì„ íƒ</label>
                        <button @click="formData.friend = 'ë…¸í”„ë Œë“œ'"
                            :class="['text-[10px] px-3 py-1 rounded-lg font-black border transition-all', 
                            formData.friend === 'ë…¸í”„ë Œë“œ' ? 'bg-red-500 text-white border-red-600 shadow-inner' : 'bg-white text-gray-500 border-gray-300']">
                            ë…¸í”„ë Œë“œ ğŸš«
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-1.5">
                        <button v-for="p in players" :key="p.name" @click="formData.friend = p.name"
                            :disabled="p.name === formData.dealer || standbyPlayer === p.name"
                            :class="[
                                'p-2 rounded-lg border-2 flex flex-col items-center justify-center transition-all relative min-h-[60px]',
                                standbyPlayer === p.name ? 'border-gray-200 bg-gray-100 opacity-40 cursor-not-allowed' :
                                p.name === formData.dealer ? 'border-amber-300 bg-gray-100 opacity-60 cursor-not-allowed' :
                                formData.friend === p.name ? 'border-blue-600 bg-white text-blue-700 shadow-md ring-1' : 'border-gray-100 bg-white'
                            ]">
                            <span v-if="p.name === formData.dealer" class="absolute top-1 right-1 bg-amber-500 text-white text-[7px] font-black px-1 rounded shadow-sm">ì£¼ê³µ</span>
                            <span v-if="standbyPlayer === p.name" class="absolute top-1 left-1 bg-red-500 text-white text-[7px] font-black px-1 rounded shadow-sm">íœ´ì‹</span>
                            
                            <span class="text-xs font-black">{{ p.name }}</span>
                            <span class="text-[12px] font-bold text-gray-500 mt-1">{{ p.chips }}</span>
                        </button>
                    </div>
                </div>

                <div class="flex-grow flex flex-col justify-center space-y-4">
                    <div class="flex items-center justify-between px-6 py-3 bg-white rounded-2xl border-2 border-gray-900 shadow-sm">
                        <div class="flex items-center gap-3">
                            <span :class="['text-3xl font-black', currentSuit.textColor]">{{ currentSuit.symbol }}</span>
                            <span class="text-2xl font-black text-gray-900">{{ formData.bid }}</span>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] font-black text-gray-400 mb-0.5">ì•¼ë‹¹ ëª©í‘œ</p>
                            <p class="text-lg font-black text-red-600">{{ 21 - formData.bid }}ì¥ ì´ìƒ</p>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-3xl border-2 border-gray-100 flex flex-col items-center shadow-sm">
                        <div class="flex justify-between w-full items-center mb-4 px-1">
                            <span class="text-[10px] font-black text-gray-400 uppercase">ì•¼ë‹¹ íšë“ ì¥ìˆ˜</span>
                            <span :class="['px-3 py-0.5 rounded-full text-[10px] font-bold text-white', isCurrentBidSuccess ? 'bg-green-500' : 'bg-red-500']">{{ isCurrentBidSuccess ? 'ì—¬ë‹¹ ìŠ¹ë¦¬' : 'ì•¼ë‹¹ ìŠ¹ë¦¬' }}</span>
                        </div>
                        <div class="flex items-center justify-center gap-10 w-full mb-4">
                            <button @click="formData.oppScore = Math.max(0, formData.oppScore - 1)" class="w-12 h-12 rounded-full bg-gray-50 border-2 text-2xl font-black text-gray-300">-</button>
                            <span class="text-7xl font-black w-24 text-center text-gray-800 tracking-tighter">{{ formData.oppScore }}</span>
                            <button @click="formData.oppScore = Math.min(20, formData.oppScore + 1)" class="w-12 h-12 rounded-full bg-gray-50 border-2 text-2xl font-black text-gray-300">+</button>
                        </div>
                        <input type="range" v-model.number="formData.oppScore" min="0" max="20" class="w-full accent-blue-600">
                    </div>
                </div>

                <div class="flex gap-2 shrink-0 pb-1">
                    <button @click="step = 3" class="flex-1 py-4 bg-gray-100 text-gray-400 rounded-2xl font-bold text-sm">ë¹„ë”© ìˆ˜ì •</button>
                    <button @click="calculateResult" :disabled="!formData.friend || loading" class="flex-[2] py-4 bg-gray-900 text-white rounded-2xl font-black text-lg shadow-xl active:scale-95 disabled:bg-gray-200">
                        <span v-if="loading">ì²˜ë¦¬ ì¤‘...</span><span v-else>ì •ì‚°í•˜ê¸°</span>
                    </button>
                </div>
            </section>

            <section v-if="step === 5" class="flex flex-col h-full space-y-3">
                <div :class="['py-5 rounded-3xl text-center border-4 shrink-0 relative overflow-hidden shadow-md', lastResult.isWin ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200']">
                    <button @click="revertResult" class="absolute top-3 left-3 text-[10px] font-bold text-gray-400 bg-white/80 px-2 py-1 rounded border shadow-sm">â¬…ï¸ ì·¨ì†Œ</button>
                    <h2 :class="['text-3xl font-black mt-2', lastResult.isWin ? 'text-green-600' : 'text-red-600']">{{ lastResult.isWin ? 'ì—¬ë‹¹ ìŠ¹ë¦¬ ğŸ‰' : 'ì•¼ë‹¹ ìŠ¹ë¦¬ ğŸ’€' }}</h2>
                    <p class="text-[11px] font-bold text-gray-500 mt-1">{{ formData.suit }} {{ formData.bid }} ë¹„ë”© <span class="mx-1">|</span> ì•¼ë‹¹ {{ formData.oppScore }}ì¥</p>
                    <div class="mt-3 inline-flex items-center bg-white px-4 py-2 rounded-full shadow-sm border">
                        <span class="text-[10px] font-black text-gray-300 mr-2">ê³„ì‚°: {{ lastResult.base }} Ã— {{ lastResult.multiplier }}</span>
                        <span class="text-base font-black text-blue-600">{{ lastResult.finalUnit }} ì </span>
                    </div>
                </div>

                <div class="flex-grow bg-white rounded-2xl shadow-inner border p-2 space-y-1 overflow-y-auto">
                    <div v-for="change in lastResult.changes" :key="change.name" 
                        :class="['flex justify-between items-center px-4 py-3 rounded-xl chip-change border', change.role === 'íœ´ì‹' ? 'bg-gray-50 opacity-50' : 'bg-white shadow-sm']">
                        
                        <div class="flex items-center gap-3">
                            <span class="font-black text-gray-800 text-sm min-w-[50px]">{{ change.name }}</span>
                            <span v-if="change.role" class="text-[9px] font-bold text-white px-1.5 py-0.5 rounded shadow-sm" :class="change.role === 'íœ´ì‹' ? 'bg-gray-300' : change.role.includes('ì£¼ê³µ') ? 'bg-blue-600' : (change.role === 'í”„ë Œë“œ' ? 'bg-blue-400' : 'bg-gray-400')">{{ change.role }}</span>
                        </div>
                        
                        <div class="flex items-center gap-5 text-right">
                            <div class="flex flex-col items-end">
                                <span class="text-[8px] text-gray-300 font-bold uppercase">ì´ì „ / ë³€ë™</span>
                                <div class="text-[12px] font-bold text-gray-400">
                                    {{ change.oldTotal }} 
                                    <span :class="['ml-1', change.diff > 0 ? 'text-green-500' : change.diff < 0 ? 'text-red-500' : 'text-gray-300']">
                                        {{ change.diff >= 0 ? '+' : '' }}{{ change.diff }}
                                    </span>
                                </div>
                            </div>
                            <div class="flex flex-col items-end min-w-[55px]">
                                <span class="text-[8px] text-gray-400 font-bold uppercase">ë³´ìœ  ì ìˆ˜</span>
                                <span class="font-black text-2xl text-gray-800 tracking-tighter">{{ change.newTotal }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="nextRound" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all">ë‹¤ìŒ ë¼ìš´ë“œ ì‹œì‘</button>
            </section>
        </main>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    step: 1, playerList: [], selectedPlayers: [], players: [],
                    standbyPlayer: null, showStandbyModal: false, newPlayerName: '',
                    loading: false, isAddingPlayer: false, gameId: '', roundCount: 1,
                    suits: [
                        { symbol: 'N', name: 'ë…¸ê¸°ë£¨', textColor: 'text-gray-400' },
                        { symbol: 'â™ ', name: 'ìŠ¤í˜ì´ë“œ', textColor: 'text-gray-900' },
                        { symbol: 'â™¦', name: 'ë‹¤ì´ì•„', textColor: 'text-red-600' },
                        { symbol: 'â™£', name: 'í´ë¡œë²„', textColor: 'text-gray-900' },
                        { symbol: 'â™¥', name: 'í•˜íŠ¸', textColor: 'text-red-600' }
                    ],
                    bids: [13, 14, 15, 16, 17, 18, 19, 20],
                    formData: { dealer: '', friend: '', suit: null, bid: null, oppScore: 0 },
                    lastResult: {}
                }
            },
            computed: {
                hasSavedSession() { return localStorage.getItem('mightySession') !== null; },
                activePlayers() { return this.players.filter(p => p.name !== this.standbyPlayer); },
                roundStartButtonText() {
                    let missing = [];
                    if (this.players.length === 6 && !this.standbyPlayer) missing.push('íœ´ì‹');
                    if (!this.formData.dealer) missing.push('ì£¼ê³µ');
                    if (!this.formData.suit || !this.formData.bid) missing.push('ë¹„ë”©');
                    return missing.length === 0 ? "ë¼ìš´ë“œ ì‹œì‘" : `ë¼ìš´ë“œ ì‹œì‘ (${missing.join(', ')})`;
                },
                isBiddingComplete() { return this.formData.dealer && this.formData.suit && this.formData.bid && (this.players.length !== 6 || this.standbyPlayer); },
                currentSuit() { return this.suits.find(s => s.name === this.formData.suit) || { symbol: '?', textColor: 'text-gray-200' }; },
                isCurrentBidSuccess() { return (20 - this.formData.oppScore) >= (this.formData.bid || 0); },
                calculateMighty() { 
                    if (!this.formData.suit) return { text: '-', color: 'text-gray-300' };
                    return this.formData.suit === 'ìŠ¤í˜ì´ë“œ' ? { text: 'â™¦A', color: 'text-red-600' } : { text: 'â™ A', color: 'text-gray-900' };
                },
                calculateJokerCall() {
                    if (!this.formData.suit) return { text: '-', color: 'text-gray-300' };
                    return this.formData.suit === 'í´ë¡œë²„' ? { text: 'â™ 3', color: 'text-gray-900' } : { text: 'â™£3', color: 'text-gray-900' }; 
                }
            },
            methods: {
                togglePlayer(name) {
                    const idx = this.selectedPlayers.indexOf(name);
                    if (idx > -1) this.selectedPlayers.splice(idx, 1);
                    else if (this.selectedPlayers.length < 6) this.selectedPlayers.push(name);
                },
                async fetchPlayers() {
                    try { const res = await fetch(CONFIG.GAS_URL); const data = await res.json(); this.playerList = data.players || []; } catch(e) {}
                },
                async addPlayer() {
                    if(!this.newPlayerName) return; 
                    this.playerList.push(this.newPlayerName); this.togglePlayer(this.newPlayerName);
                    fetch(CONFIG.GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "addPlayer", name: this.newPlayerName }) });
                    this.newPlayerName = '';
                },
                selectDealer(name) { if(this.standbyPlayer !== name) this.formData.dealer = name; },
                setStandby(name) { 
                    this.standbyPlayer = name; 
                    if(this.formData.dealer === name) this.formData.dealer = '';
                    this.showStandbyModal = false; this.saveSession(); 
                },
                async startGame() {
                    this.loading = true; this.gameId = `M_${Date.now()}`; this.roundCount = 1; this.players = this.selectedPlayers.map(name => ({ name, chips: 40 }));
                    fetch(CONFIG.GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "startGame", gameId: this.gameId, players: this.players }) });
                    this.saveSession(); this.step = 3; this.loading = false;
                },
                saveSession() { localStorage.setItem('mightySession', JSON.stringify({ gameId: this.gameId, roundCount: this.roundCount, players: this.players, standbyPlayer: this.standbyPlayer })); },
                loadSession() { const d = JSON.parse(localStorage.getItem('mightySession')); this.gameId=d.gameId; this.roundCount=d.roundCount; this.players=d.players; this.standbyPlayer=d.standbyPlayer; this.selectedPlayers=this.players.map(p=>p.name); this.step=3; },
                endGame() { 
                    if(confirm("ê¸°ë¡ì„ ì™„ì „íˆ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (íœ´ì‹ ë° ì£¼ê³µ ì„¤ì •ë„ ì´ˆê¸°í™”ë©ë‹ˆë‹¤)")) {
                        localStorage.removeItem('mightySession'); 
                        this.standbyPlayer = null;
                        this.formData = { dealer: '', friend: '', suit: null, bid: null, oppScore: 0 };
                        this.selectedPlayers = [];
                        this.step = 1; 
                    } 
                },
                async calculateResult() {
                    this.loading = true;
                    const { dealer, friend, suit, bid, oppScore } = this.formData;
                    const wonCards = 20 - oppScore; const isWin = wonCards >= bid;
                    const isRun = (oppScore === 0); const isBackrun = (oppScore >= 10);
                    let base = 0;
                    if (bid === 20) base = isWin || isBackrun ? 20 : Math.ceil((bid - wonCards) * 1.5);
                    else base = isWin ? (isRun ? 15 : wonCards - 10) : (isBackrun ? 15 : bid - wonCards);
                    
                    const multiplier = (suit === 'ë…¸ê¸°ë£¨' ? 2 : 1) * (friend === 'ë…¸í”„ë Œë“œ' ? 2 : 1);
                    const finalUnit = base * multiplier;
                    
                    let changes = this.players.map(p => {
                        const oldTotal = p.chips;
                        let role = 'ì•¼ë‹¹'; let diff = 0;
                        if (p.name === this.standbyPlayer) { role = 'íœ´ì‹'; diff = 0; }
                        else if (p.name === dealer) {
                            role = friend === 'ë…¸í”„ë Œë“œ' ? 'ì£¼ê³µ(ë…¸í”„)' : 'ì£¼ê³µ';
                            diff = isWin ? (friend === 'ë…¸í”„ë Œë“œ' ? finalUnit * 4 : finalUnit * 2) : (friend === 'ë…¸í”„ë Œë“œ' ? -finalUnit * 4 : -finalUnit * 2);
                        }
                        else if (p.name === friend) { role = 'í”„ë Œë“œ'; diff = isWin ? finalUnit : -finalUnit; }
                        else { diff = isWin ? -finalUnit : finalUnit; }
                        p.chips += diff;
                        return { name: p.name, role, diff, oldTotal, newTotal: p.chips };
                    });

                    this.lastResult = { isWin, base, multiplier, finalUnit, changes };
                    fetch(CONFIG.GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "recordRound", gameId: this.gameId, round: this.roundCount, dealer, friend, suit, bid, oppScore, result: isWin ? "ìŠ¹ë¦¬" : "íŒŒì•¡", changesLog: changes.map(c=>`${c.name}:${c.diff}`).join(','), players: this.players }) });
                    this.saveSession(); this.loading = false; this.step = 5;
                },
                revertResult() {
                    if(!confirm("ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                    this.lastResult.changes.forEach(c => { const p = this.players.find(x => x.name === c.name); if(p) p.chips -= c.diff; });
                    this.saveSession(); this.step = 4; 
                },
                nextRound() {
                    if (this.players.length === 6) {
                        if (this.lastResult.isWin) { if (this.formData.friend !== 'ë…¸í”„ë Œë“œ') this.standbyPlayer = this.formData.friend; }
                        else { this.standbyPlayer = this.formData.dealer; }
                    }
                    this.formData = { dealer: '', friend: '', suit: null, bid: null, oppScore: 0 };
                    this.roundCount++; this.saveSession(); this.step = 3;
                }
            },
            mounted() { this.fetchPlayers(); }
        }).mount('#app')
    </script>
</body>
</html>